# This workflow will build and test Swift project on Linux
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: Swift Build & Test

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'Notes/**'
      - '.devcontainer/**'
      - 'README*'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'Notes/**'
      - '.devcontainer/**'
      - 'README*'

jobs:
  build:
    runs-on: ubuntu-22.04 # Linux runner (matching production environment)
    container:
      image: swift:6.2

    steps:
    - uses: actions/checkout@v4
    
    - name: Clean build artifacts
      run: |
        rm -rf .build
        swift package clean
    
    - name: Build
      run: swift build
    
    - name: Run tests
      run: swift test
      timeout-minutes: 30

  test-typescript-sdk:
    runs-on: ubuntu-22.04
    container:
      image: swift:6.2
      env:
        NODE_VERSION: 20

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Node.js
      run: |
        apt-get update
        apt-get install -y curl
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt-get install -y nodejs
        node --version && npm --version
    
    - name: Setup npm cache
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('sdk/ts/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      working-directory: sdk/ts
      run: npm ci
    
    - name: Build TypeScript SDK
      working-directory: sdk/ts
      run: npm run build
    
    - name: Run TypeScript SDK tests
      working-directory: sdk/ts
      run: npm test
