import type { ProtocolSchema } from './schema.js'
import { mapSchemaDefToTsType, type TypeMapperContext } from './typeMapper.js'

function generateHeader(): string {
  return [
    '// AUTO-GENERATED BY @swiftstatetree/sdk codegen.',
    '// Do not edit this file directly.',
    '',
  ].join('\n')
}

/**
 * Generate the contents of defs.ts.
 */
export function generateDefsTs(schema: ProtocolSchema): string {
  const lines: string[] = []
  lines.push(generateHeader())

  const defNames = Object.keys(schema.defs)
  const ctx: TypeMapperContext = {
    knownDefs: new Set(defNames)
  }

  // Keep output stable by sorting definition names.
  const sortedDefNames = [...defNames].sort()

  for (const name of sortedDefNames) {
    const def = schema.defs[name]
    const tsType = mapSchemaDefToTsType(def, ctx)
    lines.push(`export type ${name} = ${tsType}`)
  }

  if (lines[lines.length - 1] !== '') {
    lines.push('')
  }

  return lines.join('\n')
}

