# State Update - Opcode + JSON Arrayï¼ˆä¿ç•™ playerID å­—ä¸²ï¼‰

æ­¤æ–‡ä»¶è¨˜éŒ„ WebSocket å‚³è¼¸çš„ç¬¬ä¸€éšæ®µå°åŒ…ç¸®æ¸›ç›®æ¨™ï¼š
ä½¿ç”¨ã€Œopcode + JSON arrayã€å–ä»£åŸæœ¬çš„ JSON ç‰©ä»¶æ ¼å¼ï¼Œä¸¦ä¿ç•™ `playerID` å­—ä¸²ã€‚

## ç‹€æ…‹

- ç›®æ¨™ï¼šä½œç‚º **éšæ®µä¸€** çš„å°åŒ…å„ªåŒ–
- ä»ä½¿ç”¨ JSONï¼ˆä¸å¼•å…¥ MessagePackï¼‰
- `playerID` ç¶­æŒå­—ä¸²ï¼ˆå°šæœªæ”¹æˆ playerIndexï¼‰
- æš«ä¸å–ä»£æ—¢æœ‰ `StateUpdate` æ ¼å¼ï¼ˆéœ€èƒ½åŠ›å”å•†/ç‰ˆæœ¬åˆ‡æ›ï¼‰

## ç›®çš„

- é™ä½é«˜é » diff åŒæ­¥çš„ payload å¤§å°
- ä¿ç•™å¯è®€æ€§èˆ‡é™¤éŒ¯å‹å–„åº¦ï¼ˆWireshark / console ä»å¯ç›´æ¥è§€å¯Ÿï¼‰
- æœ€å°åŒ–æ”¹å‹•æˆæœ¬ï¼Œå…ˆç©©å®šå”å®šèˆ‡åŒæ­¥æ¨¡å‹

## å°åŒ…çµæ§‹ï¼ˆæ¦‚è§€ï¼‰

```json
[MSG_DIFF, PLAYER_UPDATE, "guest-799195",
  [fieldId, OP_SET, 10000, 20000],
  [fieldId2, OP_REMOVE]
]
```

æ¬„ä½èªªæ˜ï¼š

- `MSG_DIFF`: å°åŒ…å±¤ç´š opcodeï¼ˆdiff æ›´æ–°ï¼‰
- `PLAYER_UPDATE`: å­é¡å‹/ç¯„åœ opcodeï¼ˆä¾‹å¦‚ç©å®¶è¦–è§’æ›´æ–°ï¼‰
- `playerID`: ç©å®¶ ID å­—ä¸²ï¼ˆä¿ç•™ï¼‰
- å¾ŒçºŒé …ç›®ï¼šæ¯ç­†è®Šæ›´çš„ patch é™£åˆ—

### ç›®å‰å¯¦ä½œï¼ˆv1ï¼‰

ç¬¬ä¸€ç‰ˆå¯¦ä½œçš„å¯¦éš›è¼¸å‡ºç‚ºï¼š

```json
[updateOpcode, playerID,
  [path, op, value?],
  [path, op]
]
```

- `updateOpcode`: `StateUpdateOpcode`ï¼ˆ`0 = noChange`, `1 = firstSync`, `2 = diff`ï¼‰
- `op`: `StatePatchOpcode`ï¼ˆ`1 = set`, `2 = remove`, `3 = add`ï¼‰
- `path`: JSON Pointer å­—ä¸²ï¼ˆæš«ä»£ `fieldId`ï¼‰

### Patch é™£åˆ—æ ¼å¼

- `OP_SET`: è¨­å€¼ï¼Œå¾Œé¢ä¾æ¬„ä½å‹åˆ¥é™„ä¸Šåƒæ•¸
  - ä¾‹ï¼š`[fieldId, OP_SET, x, y]`
- `OP_REMOVE`: ç§»é™¤
  - ä¾‹ï¼š`[fieldId, OP_REMOVE]`
- `OP_ADD`: æ–°å¢
  - ä¾‹ï¼š`[fieldId, OP_ADD, value]`

`fieldId` èˆ‡ `OP_*` çš„å¯¦éš›æ•¸å€¼ç”±å”è­°å¸¸æ•¸å®šç¾©ï¼›
`OP_SET` çš„åƒæ•¸å€‹æ•¸ç”±æ¬„ä½å‹åˆ¥æ±ºå®šï¼ˆä¾‹å¦‚ position ä½¿ç”¨ 2 å€‹æ•´æ•¸ï¼‰ã€‚

**ç¬¬ä¸€ç‰ˆå¯¦ä½œèªªæ˜ï¼š**

- `fieldId` å°šæœªå°å…¥æ™‚ï¼Œpatch æœƒä½¿ç”¨ `path` å­—ä¸²ä½œç‚ºç¬¬ä¸€æ¬„ä½
- opcodes ä»¥æ•´æ•¸è¼¸å‡ºï¼Œä½† patch èªæ„ä»èˆ‡ç¾æœ‰ JSON Patch å°æ‡‰

## èˆ‡ç¾æœ‰ JSON ç‰©ä»¶æ ¼å¼çš„å°ç…§

ç¾è¡Œ `StateUpdate`ï¼š

```json
{
  "type": "diff",
  "patches": [
    { "op": "replace", "path": "/players/guest-799195/position", "value": { "x": 10000, "y": 20000 } },
    { "op": "remove", "path": "/players/guest-799195/target" }
  ]
}
```

ç›®æ¨™ opcode é™£åˆ—ï¼š

```json
[MSG_DIFF, PLAYER_UPDATE, "guest-799195",
  [fieldIdForPosition, OP_SET, 10000, 20000],
  [fieldIdForTarget, OP_REMOVE]
]
```

## é©ç”¨éšæ®µ

- Prototype / åˆæœŸï¼šå…ˆç©©å®š diff çµæ§‹èˆ‡åŒæ­¥èªæ„
- Beta / å£“æ¸¬ï¼šå†åˆ‡æ› MessagePackï¼ˆçµæ§‹ä¸è®Šï¼‰
- ä¸Šç·š / é«˜é »åŒæ­¥ï¼šé€²ä¸€æ­¥æ”¹ç‚º playerIndex

## å¾ŒçºŒæ¼”é€²

1. **MessagePack**ï¼šä¿ç•™çµæ§‹ã€æ”¹ç·¨ç¢¼
2. **playerIndex**ï¼šjoin æ™‚å»ºç«‹ `index â†” playerID` æ˜ å°„

æ­¤æ–‡ä»¶åƒ…æè¿° **éšæ®µä¸€** çš„ç›®æ¨™ï¼Œä¸ä»£è¡¨æœ€çµ‚å”å®šå®šç¨¿ã€‚

## è¨­å®šæ–¹å¼ï¼ˆç¨‹å¼ç¢¼ï¼‰

ç¬¬ä¸€ç‰ˆä»¥ç¨‹å¼ç¢¼æŒ‡å®šç·¨ç¢¼çµ„åˆï¼Œå¯é¸æ“‡ï¼š

- `TransportEncoding.message`
- `StateUpdateEncoding.stateUpdate`

ç¯„ä¾‹ï¼š

```swift
let config = TransportEncodingConfig(
    message: .json,
    stateUpdate: .opcodeJsonArray
)
```

å•Ÿå‹•æ™‚ logger æœƒè¼¸å‡ºç›®å‰ä½¿ç”¨çš„ `messageEncoding` èˆ‡ `stateUpdateEncoding`ã€‚

## å¯¦æ¸¬ç´€éŒ„ï¼ˆHero Defense / 1 ç©å®¶ / 180 ç§’ / 1 æ€ªç‰©ç”Ÿæˆï¼‰
**æ¸¬è©¦æ—¥æœŸ**: 2026-01-11
**æ¸¬è©¦ç’°å¢ƒ**: GameDemo (localhost), 1 Player, å›ºå®šæ¯æ¬¡ç”Ÿæˆ 1 éš»æ€ªç‰©

### æ¸¬è©¦çµæœæ¯”è¼ƒ

| é …ç›® | JSON Object (Baseline) | Opcode JSON Array (Legacy) | Opcode JSON Array (PathHash) |
|------|------------------------|----------------------------|------------------------------|
| **å¹³å‡å°åŒ…å¤§å°** | **1789.86 bytes** | **1208.84 bytes** | **955.89 bytes** |
| **vs Baseline** | - | **â†“ 32.5%** | **â†“ 46.6%** |
| **vs Legacy** | - | - | **â†“ 20.9%** |

### è©³ç´°æ•¸æ“š

#### 1. JSON Object (Baseline)
- å¹³å‡å¤§å°: 1789.86 bytes/å°åŒ…
- æ¯ç§’æµé‡: ~17.89 KB/s

#### 2. Opcode JSON Array (Legacy)
- æ ¼å¼: `[path, op, value]`
- å¹³å‡å¤§å°: 1208.84 bytes/å°åŒ…
- æ¯ç§’æµé‡: ~12.08 KB/s
- æ”¹å–„: æ¯” Baseline æ¸›å°‘ 32.5%

#### 3. Opcode JSON Array (PathHash)
- æ ¼å¼: `[pathHash, dynamicKey, op, value]`
- å¹³å‡å¤§å°: 955.89 bytes/å°åŒ…
- æ¯ç§’æµé‡: ~9.55 KB/s
- æ”¹å–„: æ¯” Baseline æ¸›å°‘ 46.6%ï¼Œæ¯” Legacy æ¸›å°‘ 20.9%

### çµè«–

PathHash å„ªåŒ–æˆåŠŸå°‡å°åŒ…å¤§å°é€²ä¸€æ­¥å£“ç¸®ã€‚åœ¨ä¸æ”¹è®Š JSON å‚³è¼¸æ ¼å¼çš„å‰æä¸‹ï¼Œåƒ…é€éå°‡ path string æ›¿æ›ç‚º hash (UInt32)ï¼Œå°±ç²å¾—äº†é¡å¤– 20% çš„é »å¯¬ç¯€çœã€‚

æ•´é«”è€Œè¨€ï¼Œç›¸è¼ƒæ–¼åŸå§‹çš„ JSON Object æ ¼å¼ï¼Œæ–°çš„ **Opcode + PathHash æ ¼å¼æ¸›å°‘äº†è¿‘ä¸€åŠ (46.6%) çš„æµé‡**ã€‚

### ä¸‹ä¸€æ­¥
- è€ƒæ…®å°å…¥ MessagePack é€²ä¸€æ­¥å£“ç¸® (binary encoding)ã€‚
- è€ƒæ…®å°‡ playerID å„ªåŒ–ç‚º playerIndexã€‚

---

### æ¸¬è©¦ 2ï¼ˆHero Defense / 1 ç©å®¶ / 180 ç§’ / å‹•æ…‹æ€ªç‰©ç”Ÿæˆï¼‰
**æ¸¬è©¦æ—¥æœŸ**: 2026-01-14
**æ¸¬è©¦ç’°å¢ƒ**: GameDemo (localhost), 1 Player, å‹•æ…‹æ€ªç‰©ç”Ÿæˆ
**PathHash ç‹€æ…‹**: âœ… å·²å•Ÿç”¨ (54 å€‹ pathHashes)

#### æ¸¬è©¦çµæœæ¯”è¼ƒ

| é …ç›® | JSON Object (Baseline) | Opcode JSON Array (PathHash) |
|------|------------------------|------------------------------|
| **å¹³å‡å°åŒ…å¤§å°** | **1773.70 bytes** | **1790.29 bytes** |
| **vs Baseline** | - | **â†‘ 0.94%** |
| **ç´¯è¨ˆå°åŒ…æ•¸** | 1798 å€‹ | 1800 å€‹ |
| **æ¯ç§’å°åŒ…æ•¸** | 9.99 å€‹/s | 10.00 å€‹/s |

#### è©³ç´°æ•¸æ“š

##### 1. JSON Object (Baseline)
- å¹³å‡å¤§å°: 1773.70 bytes/å°åŒ…
- ç´¯è¨ˆæµé‡: 3.04 MB (17717.24 B/s)
- ç´¯è¨ˆå°åŒ…: 1798 å€‹ (9.99 å€‹/s)

##### 2. Opcode JSON Array (PathHash)
- æ ¼å¼: `[pathHash, dynamicKey, op, value]`
- å¹³å‡å¤§å°: 1790.29 bytes/å°åŒ…
- ç´¯è¨ˆæµé‡: 3.07 MB (17902.89 B/s)
- ç´¯è¨ˆå°åŒ…: 1800 å€‹ (10.00 å€‹/s)
- ç›¸å° Baseline: å¢åŠ  0.94%

#### è§€å¯Ÿèˆ‡åˆ†æ

æœ¬æ¬¡æ¸¬è©¦ä¸­ï¼ŒOpcode JSON Array (PathHash) æ¨¡å¼çš„å°åŒ…å¤§å°ç•¥å¤§æ–¼ JSON Object æ¨¡å¼ã€‚å¯èƒ½åŸå› ï¼š

1. **éŠæˆ²ç‹€æ…‹è¤‡é›œåº¦**: å‹•æ…‹æ€ªç‰©ç”Ÿæˆå¯èƒ½å°è‡´ç‹€æ…‹æ›´æ–°æ›´é »ç¹ï¼ŒPathHash æ ¼å¼çš„é¡å¤–çµæ§‹é–‹éŠ·ï¼ˆpathHash + dynamicKeyï¼‰åœ¨æŸäº›æƒ…æ³ä¸‹å¯èƒ½è¶…é path string çš„é•·åº¦
2. **æ¸¬è©¦ç’°å¢ƒå·®ç•°**: èˆ‡æ¸¬è©¦ 1 ç›¸æ¯”ï¼Œæœ¬æ¬¡æ¸¬è©¦ä½¿ç”¨å‹•æ…‹æ€ªç‰©ç”Ÿæˆï¼ŒéŠæˆ²ç‹€æ…‹è®ŠåŒ–æ¨¡å¼å¯èƒ½ä¸åŒ
3. **ç·¨ç¢¼å„ªåŒ–**: PathHash çš„å„ªå‹¢åœ¨ path string è¼ƒé•·æ™‚æ›´æ˜é¡¯ï¼Œç•¶ path è¼ƒçŸ­æ™‚ï¼Œhash (UInt32) + dynamicKey çš„çµ„åˆå¯èƒ½ä¸å¦‚ç›´æ¥ä½¿ç”¨ path string ç¯€çœç©ºé–“

#### çµè«–

PathHash å„ªåŒ–åœ¨æ¸¬è©¦ 1 ä¸­é¡¯ç¤ºå‡ºé¡¯è‘—çš„é »å¯¬ç¯€çœï¼ˆ46.6%ï¼‰ï¼Œä½†åœ¨æ¸¬è©¦ 2 ä¸­è¡¨ç¾ç•¥éœæ–¼ Baselineã€‚é€™è¡¨æ˜ï¼š

- PathHash çš„å£“ç¸®æ•ˆæœèˆ‡éŠæˆ²ç‹€æ…‹çš„å…·é«”æ¨¡å¼ç›¸é—œ
- ç•¶ path string è¼ƒçŸ­æˆ–ç‹€æ…‹æ›´æ–°æ¨¡å¼ä¸åŒæ™‚ï¼ŒPathHash çš„å„ªå‹¢å¯èƒ½ä¸æ˜é¡¯
- éœ€è¦é€²ä¸€æ­¥å„ªåŒ–ç·¨ç¢¼ç­–ç•¥ï¼Œæ ¹æ“šå¯¦éš› path é•·åº¦å‹•æ…‹é¸æ“‡ä½¿ç”¨ pathHash æˆ– path string

### ä¸‹ä¸€æ­¥ï¼ˆæ›´æ–°ï¼‰
- è€ƒæ…®å°å…¥ MessagePack é€²ä¸€æ­¥å£“ç¸® (binary encoding)ã€‚
- è€ƒæ…®å°‡ playerID å„ªåŒ–ç‚º playerIndexã€‚
- å„ªåŒ– PathHash ç·¨ç¢¼ç­–ç•¥ï¼Œæ ¹æ“š path é•·åº¦å‹•æ…‹é¸æ“‡ç·¨ç¢¼æ–¹å¼ã€‚

---

## å°åŒ…çµæ§‹åˆ†æï¼šPathHash åœ¨ JSON ä¸­è®Šå¤§çš„åŸå› 

### å•é¡Œæ‹†è§£

#### 1. PathHash æ ¼å¼çš„å¯¦éš›ç·¨ç¢¼é–‹éŠ·

**PathHash æ ¼å¼ï¼š** `[pathHash, dynamicKey, op, value?]`

å¯¦éš› JSON ç·¨ç¢¼ç¯„ä¾‹ï¼š
```json
[2, "guest-799195", [2558331159, [0, "guest-799195"], 1, 100]]
```

æ‹†è§£åˆ†æï¼š
- `2`: diff opcode (1 å­—ç¬¦)
- `"guest-799195"`: playerID (15 å­—ç¬¦)
- `[2558331159, [0, "guest-799195"], 1, 100]`: patch é™£åˆ—
  - `2558331159`: pathHash (10 å­—ç¬¦) - **å•é¡Œï¼šUInt32 åœ¨ JSON ä¸­æ˜¯ 10 å­—ç¬¦ï¼Œè€Œä¸æ˜¯ 4 bytes**
  - `[0, "guest-799195"]`: dynamicKey ç¬¬ä¸€æ¬¡å®šç¾© (20+ å­—ç¬¦) - **å•é¡Œï¼šç¬¬ä¸€æ¬¡å®šç¾©æ™‚éœ€è¦åŒ…å«å®Œæ•´ key**
  - `1`: opcode (1 å­—ç¬¦)
  - `100`: value (3 å­—ç¬¦)
  - é™£åˆ—çµæ§‹ç¬¦è™Ÿ: `[`, `]`, `,`, ç©ºæ ¼ç­‰ (~10 å­—ç¬¦)

**ç¸½è¨ˆï¼š** ç´„ 60+ å­—ç¬¦

#### 2. JSON Object æ ¼å¼çš„å¯¦éš›ç·¨ç¢¼

**JSON Object æ ¼å¼ï¼š**
```json
{"type":"diff","patches":[{"op":"replace","path":"/players/guest-799195/hp","value":100}]}
```

æ‹†è§£åˆ†æï¼š
- `{"type":"diff","patches":[`: çµæ§‹é–‹éŠ· (~25 å­—ç¬¦)
- `{"op":"replace","path":"/players/guest-799195/hp","value":100}`: patch ç‰©ä»¶
  - `"op":"replace"`: 13 å­—ç¬¦
  - `"path":"/players/guest-799195/hp"`: 35 å­—ç¬¦
  - `"value":100`: 10 å­—ç¬¦
  - çµæ§‹ç¬¦è™Ÿ: `{`, `}`, `,`, `:` (~5 å­—ç¬¦)

**ç¸½è¨ˆï¼š** ç´„ 88 å­—ç¬¦

### é—œéµå•é¡Œåˆ†æ

#### å•é¡Œ 1ï¼šdynamicKey ç¬¬ä¸€æ¬¡å®šç¾©çš„é–‹éŠ·
- **PathHash**: `[0, "guest-799195"]` = 20+ å­—ç¬¦ï¼ˆéœ€è¦åŒ…å« slot å’Œå®Œæ•´ keyï¼‰
- **JSON Object**: ç›´æ¥ä½¿ç”¨ path stringï¼Œé›–ç„¶é•·ä½†çµæ§‹ç°¡å–®

#### å•é¡Œ 2ï¼špathHash åœ¨ JSON ä¸­çš„å¤§å°ï¼ˆ**ä¸»è¦å•é¡Œ**ï¼‰
- **UInt32** (ä¾‹å¦‚ 2558331159) åœ¨ JSON ä¸­æ˜¯ **10 å€‹å­—ç¬¦**
- åœ¨äºŒé€²åˆ¶æ ¼å¼ä¸­åªéœ€è¦ **4 bytes**
- **æå¤±ï¼š** 60% çš„ç©ºé–“æ•ˆç‡

#### å•é¡Œ 3ï¼šé™£åˆ— vs ç‰©ä»¶çš„ JSON é–‹éŠ·
- JSON é™£åˆ—éœ€è¦ `[`, `]`, `,` ç­‰ç¬¦è™Ÿ
- JSON ç‰©ä»¶éœ€è¦ `{`, `}`, `:`, `,` ç­‰ç¬¦è™Ÿ
- PathHash æ ¼å¼æœ‰ 4 å€‹å…ƒç´ ï¼ŒJSON Object åªæœ‰ 3 å€‹æ¬„ä½

### MessagePack çš„é æœŸå½±éŸ¿

#### MessagePack çš„å„ªå‹¢

1. **æ•¸å­—ç·¨ç¢¼**
   - UInt32 (2558331159) åœ¨ JSON: 10 å­—ç¬¦
   - UInt32 åœ¨ MessagePack: 4 bytes (uint32)
   - **ç¯€çœï¼š** 60%

2. **å­—ä¸²ç·¨ç¢¼**
   - å­—ä¸²åœ¨ JSON: `"guest-799195"` = 15 å­—ç¬¦
   - å­—ä¸²åœ¨ MessagePack: 1 byte (str8 header) + 13 bytes (å…§å®¹) = 14 bytes
   - **ç¯€çœï¼š** ç´„ 7%

3. **é™£åˆ—ç·¨ç¢¼**
   - JSON é™£åˆ—: `[2558331159, [0, "guest-799195"], 1, 100]` = ~50 å­—ç¬¦
   - MessagePack é™£åˆ—: 1 byte (array header) + å…§å®¹ = ~25 bytes
   - **ç¯€çœï¼š** ç´„ 50%

4. **çµæ§‹é–‹éŠ·**
   - JSON éœ€è¦ `[`, `]`, `,`, `:`, `"` ç­‰ç¬¦è™Ÿ
   - MessagePack ä½¿ç”¨é¡å‹æ¨™è¨˜ï¼Œé–‹éŠ·æ›´å°

#### é ä¼°æ”¹å–„

**PathHash + MessagePack vs PathHash + JSON:**
- pathHash: 10 å­—ç¬¦ â†’ 4 bytes (**60% ç¯€çœ**)
- dynamicKey é™£åˆ—: ~20 å­—ç¬¦ â†’ ~12 bytes (**40% ç¯€çœ**)
- æ•´é«”å°åŒ…: é ä¼° **40-50% ç¯€çœ**

**PathHash + MessagePack vs JSON Object + JSON:**
- é ä¼° **50-60% ç¯€çœ**

### çµè«–

1. **PathHash åœ¨ JSON ä¸­è®Šå¤§çš„ä¸»è¦åŸå› ï¼š**
   - âœ… dynamicKey ç¬¬ä¸€æ¬¡å®šç¾©æ™‚ä½¿ç”¨ `[slot, "key"]` æ ¼å¼ï¼Œé–‹éŠ·è¼ƒå¤§
   - âœ… **pathHash (UInt32) åœ¨ JSON ä¸­æ˜¯ 10 å­—ç¬¦ï¼Œè€Œä¸æ˜¯ 4 bytesï¼ˆé€™æ˜¯ä¸»è¦å•é¡Œï¼‰**
   - âœ… JSON é™£åˆ—çš„çµæ§‹é–‹éŠ·

2. **MessagePack çš„å½±éŸ¿ï¼š**
   - âœ… æœƒå¤§å¹…æ”¹å–„ PathHash æ ¼å¼çš„è¡¨ç¾
   - âœ… é ä¼°å¯ä»¥é”åˆ° **40-50% çš„é¡å¤–ç¯€çœ**
   - âœ… ç‰¹åˆ¥æ˜¯åœ¨æ•¸å­—å’Œé™£åˆ—ç·¨ç¢¼ä¸Šï¼ŒMessagePack çš„å„ªå‹¢éå¸¸æ˜é¡¯

3. **å»ºè­°ï¼š**
   - ğŸ¯ **å„ªå…ˆå°å…¥ MessagePack**ï¼šPathHash æ ¼å¼åœ¨ MessagePack ä¸­çš„å„ªå‹¢æœƒéå¸¸æ˜é¡¯
   - ğŸ¯ è€ƒæ…®å„ªåŒ– dynamicKey çš„ç·¨ç¢¼ç­–ç•¥ï¼ˆä¾‹å¦‚ä½¿ç”¨æ›´çŸ­çš„ key æˆ–æ›´å¥½çš„å£“ç¸®ï¼‰
   - ğŸ¯ MessagePack å°å…¥å¾Œï¼Œé æœŸ PathHash æ ¼å¼å¯ä»¥é”åˆ°æ¯” JSON Object æ›´å¥½çš„å£“ç¸®æ•ˆæœ

---

## ç‚ºä»€éº¼å¯¦éš›æ¸¬è©¦çµæœå’Œç†è«–åˆ†ææœ‰å·®ç•°ï¼Ÿ

### å•é¡Œï¼šç†è«–åˆ†æé¡¯ç¤º PathHash æ‡‰è©²æ›´å°ï¼Œä½†å¯¦éš›æ¸¬è©¦çµæœå»å·®ä¸å¤š

**æ¸¬è©¦æ•¸æ“šï¼š**
- JSON Object: 1773.70 bytes/å°åŒ…
- PathHash: 1790.29 bytes/å°åŒ…ï¼ˆåè€Œå¤§äº† 0.94%ï¼‰

### å¯¦éš›å°åŒ…åˆ†æ

#### 1. å¯¦éš›å°åŒ…ä¸­çš„ Patches æ•¸é‡

**ä¼°ç®—æ¯å€‹å°åŒ…çš„ patches æ•¸é‡ï¼š**
- å¹³å‡æ¯å€‹ patch å¤§å°ï¼š
  - JSON Object: ç´„ 60-80 bytesï¼ˆåŒ…å«å®Œæ•´ pathï¼‰
  - PathHash (é¦–æ¬¡å®šç¾©): ç´„ 50-60 bytesï¼ˆåŒ…å« dynamicKey å®šç¾©ï¼‰
  - PathHash (å¾ŒçºŒæ›´æ–°): ç´„ 30-40 bytesï¼ˆåªæœ‰ slotï¼‰

**ä¼°ç®—çµæœï¼š**
- JSON Object: 1773 / 70 â‰ˆ **25 å€‹ patches/å°åŒ…**
- PathHash: 1790 / 45 â‰ˆ **40 å€‹ patches/å°åŒ…**ï¼ˆå¦‚æœéƒ½æ˜¯é¦–æ¬¡å®šç¾©ï¼‰

#### 2. é—œéµå•é¡Œï¼šdynamicKey å®šç¾©çš„ç´¯ç©é–‹éŠ·

**PathHash æ ¼å¼çš„å•é¡Œï¼š**
- æ¯æ¬¡é‡åˆ°æ–°çš„ dynamicKeyï¼ˆå¦‚æ–°çš„ playerIDã€monsterIDã€turretIDï¼‰ï¼Œéƒ½éœ€è¦å®šç¾©ä¸€æ¬¡
- å®šç¾©æ ¼å¼ï¼š`[slot, "key"]` = ç´„ 20 å­—ç¬¦
- åœ¨å¯¦éš›éŠæˆ²ä¸­ï¼Œå¯èƒ½æœ‰å¾ˆå¤šä¸åŒçš„ keyï¼š
  - ç©å®¶ ID: `guest-799195`
  - æ€ªç‰© ID: `1`, `2`, `3`, ...ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
  - ç ²å¡” ID: `1`, `2`, `3`, ...ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰

**å¯¦éš›å ´æ™¯åˆ†æï¼š**
å‡è¨­ä¸€å€‹å°åŒ…åŒ…å«ï¼š
- 1 å€‹ç©å®¶æ›´æ–°ï¼ˆ5 å€‹ patchesï¼šposition.x, position.y, health, resources, rotationï¼‰
- 5 å€‹æ€ªç‰©æ›´æ–°ï¼ˆæ¯å€‹æ€ªç‰© 3 å€‹ patchesï¼šposition.x, position.y, healthï¼‰
- 2 å€‹ç ²å¡”æ›´æ–°ï¼ˆæ¯å€‹ç ²å¡” 2 å€‹ patchesï¼šposition.x, rotationï¼‰
- 1 å€‹ base æ›´æ–°ï¼ˆ2 å€‹ patchesï¼šhealth, position.xï¼‰

**ç¸½è¨ˆï¼šç´„ 23 å€‹ patches**

**dynamicKey å®šç¾©é–‹éŠ·ï¼š**
- å¦‚æœé€™äº›éƒ½æ˜¯ç¬¬ä¸€æ¬¡å‡ºç¾ï¼š
  - 1 å€‹ç©å®¶ ID å®šç¾©
  - 5 å€‹æ€ªç‰© ID å®šç¾©ï¼ˆæ–°æ€ªç‰©ä¸æ–·ç”Ÿæˆï¼‰
  - 2 å€‹ç ²å¡” ID å®šç¾©
  - **ç¸½è¨ˆï¼š8 å€‹ dynamicKey å®šç¾©**
  - æ¯å€‹å®šç¾©ç´„ 20 å­—ç¬¦ï¼Œç¸½è¨ˆç´„ **160 å­—ç¬¦çš„é¡å¤–é–‹éŠ·**

#### 3. ç‚ºä»€éº¼ç†è«–åˆ†æé¡¯ç¤º PathHash æ›´å°ï¼Ÿ

**ç†è«–åˆ†æçš„å‡è¨­ï¼š**
- âœ… åªè€ƒæ…®å–®å€‹ patch çš„æ¯”è¼ƒ
- âœ… å‡è¨­ dynamicKey å·²ç¶“å®šç¾©éï¼ˆå¾ŒçºŒæ›´æ–°ï¼‰
- âœ… å‡è¨­ path è¼ƒé•·ï¼ˆå¦‚ `players.*.position.v.x` = 35 å­—ç¬¦ï¼‰

**å¯¦éš›æƒ…æ³ï¼š**
- âŒ å°åŒ…åŒ…å«å¤šå€‹ patchesï¼ˆå¹³å‡ 25-40 å€‹ï¼‰
- âŒ å¾ˆå¤š dynamicKey æ˜¯ç¬¬ä¸€æ¬¡å®šç¾©ï¼ˆæ–°å¯¦é«”ä¸æ–·å‡ºç¾ï¼‰
- âŒ æœ‰äº› path è¼ƒçŸ­ï¼ˆå¦‚ `players.*.health` = 20 å­—ç¬¦ï¼‰

#### 4. å¯¦éš›éŠæˆ²ç‹€æ…‹æ›´æ–°çš„ç‰¹é»

**GameDemo çš„å¯¦éš›æ›´æ–°æ¨¡å¼ï¼š**
1. **ç©å®¶æ›´æ–°**ï¼šä½ç½®ã€æ—‹è½‰ã€ç”Ÿå‘½å€¼ç­‰ï¼ˆæ¯å€‹ç©å®¶å¤šå€‹æ¬„ä½ï¼‰
2. **æ€ªç‰©æ›´æ–°**ï¼šä½ç½®ã€ç”Ÿå‘½å€¼ã€é€²åº¦ç­‰ï¼ˆæ¯å€‹æ€ªç‰©å¤šå€‹æ¬„ä½ï¼‰
   - âš ï¸ **é—œéµ**ï¼šåœ¨å‹•æ…‹æ€ªç‰©ç”Ÿæˆå ´æ™¯ä¸­ï¼Œæ–°æ€ªç‰©ä¸æ–·å‡ºç¾
   - æ¯å€‹æ–°æ€ªç‰©éƒ½éœ€è¦å®šç¾© dynamicKey
3. **ç ²å¡”æ›´æ–°**ï¼šä½ç½®ã€æ—‹è½‰ã€ç­‰ç´šç­‰ï¼ˆæ¯å€‹ç ²å¡”å¤šå€‹æ¬„ä½ï¼‰
4. **Base æ›´æ–°**ï¼šç”Ÿå‘½å€¼ã€ä½ç½®ç­‰

**é—œéµè§€å¯Ÿï¼š**
- åœ¨å‹•æ…‹éŠæˆ²ä¸­ï¼Œæ–°å¯¦é«”ï¼ˆæ€ªç‰©ã€ç ²å¡”ï¼‰ä¸æ–·å‡ºç¾
- æ¯å€‹æ–°å¯¦é«”éƒ½éœ€è¦å®šç¾© dynamicKey
- å®šç¾©é–‹éŠ·ç´¯ç©ï¼š`[slot, "key"]` æ¯”ç›´æ¥ä½¿ç”¨ path string åœ¨æŸäº›æƒ…æ³ä¸‹æ›´å¤§

### çµè«–ï¼šç‚ºä»€éº¼å¯¦éš›æ¸¬è©¦çµæœå’Œç†è«–åˆ†ææœ‰å·®ç•°

**ä¸»è¦åŸå› ï¼š**

1. âœ… **dynamicKey å®šç¾©é–‹éŠ·ç´¯ç©**
   - åœ¨å‹•æ…‹éŠæˆ²ä¸­ï¼Œæ–°å¯¦é«”ï¼ˆæ€ªç‰©ã€ç ²å¡”ï¼‰ä¸æ–·å‡ºç¾
   - æ¯å€‹æ–°å¯¦é«”éƒ½éœ€è¦å®šç¾© dynamicKey
   - å®šç¾©é–‹éŠ·ï¼š`[slot, "key"]` ç´¯ç©å¾Œå¯èƒ½è¶…é path string çš„é–‹éŠ·

2. âœ… **PathHash åœ¨ JSON ä¸­çš„é–‹éŠ·**
   - UInt32 hash (10 å­—ç¬¦) åœ¨ JSON ä¸­æ¯”é æœŸå¤§
   - é™£åˆ—æ ¼å¼çš„çµæ§‹é–‹éŠ·ï¼ˆ`[`, `]`, `,`ï¼‰ç´¯ç©

3. âœ… **å¯¦éš›æ›´æ–°æ¨¡å¼**
   - å¯èƒ½æœ‰å¾ˆå¤šçŸ­ pathï¼ˆå¦‚ `players.*.health` = 20 å­—ç¬¦ï¼‰
   - çŸ­ path æ™‚ï¼ŒPathHash çš„å„ªå‹¢ä¸æ˜é¡¯
   - é•· path æ™‚ï¼ˆå¦‚ `players.*.position.v.x` = 35 å­—ç¬¦ï¼‰ï¼ŒPathHash æ‰æœ‰æ˜é¡¯å„ªå‹¢

4. âœ… **JSON ç·¨ç¢¼çš„å¯¦éš›è¡Œç‚º**
   - JSON ç·¨ç¢¼å™¨å¯èƒ½æœ‰å„ªåŒ–
   - ç‰©ä»¶æ ¼å¼å’Œé™£åˆ—æ ¼å¼çš„å¯¦éš›ç·¨ç¢¼é–‹éŠ·å¯èƒ½ç›¸è¿‘

### MessagePack çš„å½±éŸ¿

**MessagePack å¯ä»¥è§£æ±ºé€™äº›å•é¡Œï¼š**

1. **æ•¸å­—ç·¨ç¢¼æ”¹å–„**
   - UInt32: 10 å­—ç¬¦ â†’ 4 bytesï¼ˆ**60% ç¯€çœ**ï¼‰
   - é€™æœƒå¤§å¹…æ¸›å°‘ pathHash çš„é–‹éŠ·

2. **dynamicKey å®šç¾©æ”¹å–„**
   - `[slot, "key"]`: 20 å­—ç¬¦ â†’ 12 bytesï¼ˆ**40% ç¯€çœ**ï¼‰
   - é€™æœƒæ¸›å°‘å®šç¾©é–‹éŠ·çš„ç´¯ç©å½±éŸ¿

3. **é™£åˆ—ç·¨ç¢¼æ”¹å–„**
   - JSON é™£åˆ—çµæ§‹é–‹éŠ· â†’ MessagePack é¡å‹æ¨™è¨˜ï¼ˆ**ç´„ 50% ç¯€çœ**ï¼‰

**é æœŸæ”¹å–„ï¼š**
- PathHash + MessagePack vs PathHash + JSON: **40-50% ç¯€çœ**
- PathHash + MessagePack vs JSON Object + JSON: **50-60% ç¯€çœ**

**çµè«–ï¼š**
- PathHash åœ¨ JSON ä¸­è¡¨ç¾ä¸ä½³çš„ä¸»è¦åŸå› æ˜¯ JSON ç·¨ç¢¼çš„é–‹éŠ·ï¼ˆç‰¹åˆ¥æ˜¯æ•¸å­—å’Œé™£åˆ—ï¼‰
- MessagePack å°å…¥å¾Œï¼ŒPathHash çš„å„ªå‹¢æœƒéå¸¸æ˜é¡¯
- é€™ä¹Ÿè§£é‡‹äº†ç‚ºä»€éº¼æ¸¬è©¦ 1ï¼ˆå›ºå®šæ€ªç‰©ç”Ÿæˆï¼‰ä¸­ PathHash è¡¨ç¾æ›´å¥½ï¼Œè€Œæ¸¬è©¦ 2ï¼ˆå‹•æ…‹æ€ªç‰©ç”Ÿæˆï¼‰ä¸­è¡¨ç¾è¼ƒå·®

---

## æ¸¬è©¦ 3ï¼ˆHero Defense / 1 ç©å®¶ / 60 ç§’ / å‹•æ…‹æ€ªç‰©ç”Ÿæˆï¼‰
**æ¸¬è©¦æ—¥æœŸ**: 2026-01-17  
**æ¸¬è©¦ç’°å¢ƒ**: GameDemo (localhost), 1 Player, å‹•æ…‹æ€ªç‰©ç”Ÿæˆ  
**PathHash ç‹€æ…‹**: âœ… å·²å•Ÿç”¨ (54 å€‹ pathHashes)  
**Schema åŠ è¼‰**: âœ… è‡ªå‹•å¾ `/schema` API åŠ è¼‰

### æ¸¬è©¦çµæœæ¯”è¼ƒ

| é …ç›® | JSON Object (Baseline) | Opcode JSON Array (PathHash) | MessagePack Binary (PathHash) | Opcode vs Baseline | MessagePack vs Baseline | MessagePack vs Opcode |
|------|------------------------|------------------------------|------------------------------|---------------------|-------------------------|----------------------|
| **StateUpdate å¹³å‡å¤§å°** | **516.77 bytes** | **256.78 bytes** | **142.30 bytes** | **â†“ 50.3%** | **â†“ 72.5%** | **â†“ 44.6%** |
| **StateUpdate ç¸½æµé‡** | **302.29 KB** | **150.21 KB** | **83.23 KB** | **â†“ 50.3%** | **â†“ 72.5%** | **â†“ 44.6%** |
| **StateUpdate å°åŒ…æ•¸** | 599 å€‹ | 599 å€‹ | 599 å€‹ | - | - | - |
| **StateUpdate é »ç‡** | 9.98 å€‹/s | 9.98 å€‹/s | 9.98 å€‹/s | - | - | - |
| **Event å¹³å‡å¤§å°** | **185.00 bytes** | **97.00 bytes** | **48.74 bytes** | **â†“ 47.6%** | **â†“ 73.7%** | **â†“ 49.8%** |
| **Event ç¸½æµé‡** | **15.36 KB** | **8.05 KB** | **4.14 KB** | **â†“ 47.6%** | **â†“ 73.1%** | **â†“ 48.6%** |
| **Event å°åŒ…æ•¸** | 85 å€‹ | 85 å€‹ | 87 å€‹ | - | - | - |
| **Event é »ç‡** | 1.42 å€‹/s | 1.42 å€‹/s | 1.45 å€‹/s | - | - | - |

> **è¨»**: MessagePack æ•¸æ“šä¾†è‡ª 2026-01-15 çš„æ¸¬è©¦çµæœï¼ˆç›¸åŒæ¸¬è©¦ç’°å¢ƒå’Œæ¢ä»¶ï¼‰

### è©³ç´°æ•¸æ“š

#### 1. JSON Object (Baseline)
- **StateUpdate**:
  - å¹³å‡å¤§å°: 516.77 bytes/å°åŒ…
  - ç´¯è¨ˆæµé‡: 302.29 KB (5159.05 B/s)
  - ç´¯è¨ˆå°åŒ…: 599 å€‹ (9.98 å€‹/s)
- **Event**:
  - å¹³å‡å¤§å°: 185.00 bytes/å°åŒ…
  - ç´¯è¨ˆæµé‡: 15.36 KB (262.08 B/s)
  - ç´¯è¨ˆå°åŒ…: 85 å€‹ (1.42 å€‹/s)

#### 2. Opcode JSON Array (PathHash)
- **æ ¼å¼**: `[pathHash, dynamicKey, op, value]` (JSON ç·¨ç¢¼)
- **StateUpdate**:
  - å¹³å‡å¤§å°: 256.78 bytes/å°åŒ…
  - ç´¯è¨ˆæµé‡: 150.21 KB (2563.55 B/s)
  - ç´¯è¨ˆå°åŒ…: 599 å€‹ (9.98 å€‹/s)
  - **ç›¸å° Baseline**: æ¸›å°‘ 50.3%
- **Event**:
  - å¹³å‡å¤§å°: 97.00 bytes/å°åŒ…
  - ç´¯è¨ˆæµé‡: 8.05 KB (137.42 B/s)
  - ç´¯è¨ˆå°åŒ…: 85 å€‹ (1.42 å€‹/s)
  - **ç›¸å° Baseline**: æ¸›å°‘ 47.6%

#### 3. MessagePack Binary (PathHash)
- **æ ¼å¼**: `[pathHash, dynamicKey, op, value]` (MessagePack äºŒé€²åˆ¶ç·¨ç¢¼)
- **StateUpdate**:
  - å¹³å‡å¤§å°: 142.30 bytes/å°åŒ…
  - ç´¯è¨ˆæµé‡: 83.23 KB (1423.00 B/s)
  - ç´¯è¨ˆå°åŒ…: 599 å€‹ (9.98 å€‹/s)
  - **ç›¸å° Baseline**: æ¸›å°‘ 72.5%
  - **ç›¸å° Opcode JSON**: æ¸›å°‘ 44.6%
- **Event**:
  - å¹³å‡å¤§å°: 48.74 bytes/å°åŒ…
  - ç´¯è¨ˆæµé‡: 4.14 KB (74.00 B/s)
  - ç´¯è¨ˆå°åŒ…: 87 å€‹ (1.45 å€‹/s)
  - **ç›¸å° Baseline**: æ¸›å°‘ 73.7%
  - **ç›¸å° Opcode JSON**: æ¸›å°‘ 49.8%

### è§€å¯Ÿèˆ‡åˆ†æ

æœ¬æ¬¡æ¸¬è©¦çµæœé¡¯ç¤ºä¸‰ç¨®ç·¨ç¢¼æ ¼å¼çš„å£“ç¸®æ•ˆæœï¼š

1. **Opcode JSON Array (PathHash) å£“ç¸®æ•ˆæœ**
   - **StateUpdate**: å¾ 516.77 bytes é™è‡³ 256.78 bytesï¼Œ**æ¸›å°‘ 50.3%**
   - **Event**: å¾ 185.00 bytes é™è‡³ 97.00 bytesï¼Œ**æ¸›å°‘ 47.6%**
   - æ¥è¿‘ç†è«–é æœŸçš„æ”¹å–„æ•ˆæœ
   - ç¸½æµé‡å¾ 302.29 KB é™è‡³ 150.21 KB

2. **MessagePack Binary (PathHash) å£“ç¸®æ•ˆæœæ›´é¡¯è‘—**
   - **StateUpdate**: å¾ 516.77 bytes é™è‡³ 142.30 bytesï¼Œ**æ¸›å°‘ 72.5%**
   - **Event**: å¾ 185.00 bytes é™è‡³ 48.74 bytesï¼Œ**æ¸›å°‘ 73.7%**
   - ç›¸æ¯” Opcode JSON Arrayï¼Œ**å†æ¸›å°‘ç´„ 44-50%**
   - é©—è­‰äº† MessagePack åœ¨æ•¸å­—å’Œé™£åˆ—ç·¨ç¢¼ä¸Šçš„å„ªå‹¢

3. **ç·¨ç¢¼æ ¼å¼å°æ¯”**
   - **JSON Object â†’ Opcode JSON Array**: æ¸›å°‘ç´„ 50%
   - **Opcode JSON Array â†’ MessagePack**: å†æ¸›å°‘ç´„ 45%
   - **JSON Object â†’ MessagePack**: ç¸½å…±æ¸›å°‘ç´„ 72-73%
   - èªªæ˜ PathHash + MessagePack çµ„åˆé”åˆ°æœ€ä½³å£“ç¸®æ•ˆæœ

4. **å°åŒ…é »ç‡ä¸€è‡´**
   - StateUpdate å’Œ Event çš„å°åŒ…é »ç‡åœ¨ä¸‰ç¨®æ ¼å¼ä¸‹åŸºæœ¬ç›¸åŒ
   - èªªæ˜ç·¨ç¢¼æ ¼å¼ä¸å½±éŸ¿æ›´æ–°é »ç‡ï¼Œåªå½±éŸ¿å°åŒ…å¤§å°

5. **èˆ‡ä¹‹å‰æ¸¬è©¦çš„å°æ¯”**
   - æ¸¬è©¦ 2ï¼ˆ2026-01-14ï¼‰ä¸­ PathHash è¡¨ç¾ç•¥éœæ–¼ Baselineï¼ˆ+0.94%ï¼‰
   - æ¸¬è©¦ 3ï¼ˆ2026-01-17ï¼‰ä¸­ PathHash è¡¨ç¾å„ªç•°ï¼ˆ-50.3%ï¼‰
   - å·®ç•°å¯èƒ½ä¾†è‡ªï¼š
     - éŠæˆ²ç‹€æ…‹æ›´æ–°æ¨¡å¼çš„è®ŠåŒ–
     - PathHash lookup table çš„å„ªåŒ–ï¼ˆ54 å€‹ pathHashesï¼‰
     - Schema è‡ªå‹•åŠ è¼‰ç¢ºä¿äº†æ­£ç¢ºçš„è§£ç¢¼

### çµè«–

1. **ä¸‰ç¨®ç·¨ç¢¼æ ¼å¼çš„å£“ç¸®æ•ˆæœå°æ¯”**
   - **Opcode JSON Array**: StateUpdate æ¸›å°‘ **50.3%**ï¼ŒEvent æ¸›å°‘ **47.6%**
   - **MessagePack Binary**: StateUpdate æ¸›å°‘ **72.5%**ï¼ŒEvent æ¸›å°‘ **73.7%**
   - **MessagePack vs Opcode JSON**: å†æ¸›å°‘ç´„ **44-50%**
   - é©—è­‰äº† MessagePack åœ¨äºŒé€²åˆ¶ç·¨ç¢¼ä¸Šçš„é¡¯è‘—å„ªå‹¢

2. **PathHash æ ¼å¼çš„å„ªå‹¢å¾—åˆ°é©—è­‰**
   - åœ¨å‹•æ…‹éŠæˆ²å ´æ™¯ä¸­ï¼ŒPathHash æ ¼å¼èƒ½å¤ æœ‰æ•ˆæ¸›å°‘é »å¯¬ä½¿ç”¨
   - ç‰¹åˆ¥æ˜¯åœ¨é«˜é »ç‹€æ…‹æ›´æ–°çš„æƒ…æ³ä¸‹ï¼Œæ”¹å–„æ•ˆæœæ˜é¡¯
   - çµåˆ MessagePack å¾Œï¼Œç¸½é«”å£“ç¸®æ•ˆæœé”åˆ° **72-73%**

3. **Schema è‡ªå‹•åŠ è¼‰çš„é‡è¦æ€§**
   - æœ¬æ¬¡æ¸¬è©¦ä¸­ï¼Œæ¸¬é‡è…³æœ¬è‡ªå‹•å¾æœå‹™å™¨åŠ è¼‰ schema
   - ç¢ºä¿äº† PathHash lookup table çš„æ­£ç¢ºåˆå§‹åŒ–
   - æ‰€æœ‰æ¶ˆæ¯éƒ½èƒ½æ­£ç¢ºåˆ†é¡ï¼Œæ²’æœ‰éºæ¼

4. **MessagePack çš„å¯¦éš›æ•ˆæœ**
   - MessagePack åœ¨æ•¸å­—ç·¨ç¢¼ï¼ˆpathHash: 10 å­—ç¬¦ â†’ 4 bytesï¼‰ä¸Šçš„å„ªå‹¢æ˜é¡¯
   - é™£åˆ—å’Œçµæ§‹ç·¨ç¢¼çš„é–‹éŠ·å¤§å¹…æ¸›å°‘
   - å¯¦éš›æ¸¬è©¦çµæœèˆ‡ç†è«–é æœŸï¼ˆ40-50% é¡å¤–ç¯€çœï¼‰ç›¸ç¬¦

### ä¸‹ä¸€æ­¥
- âœ… PathHash æ ¼å¼å·²é©—è­‰æœ‰æ•ˆï¼Œå¯ç¹¼çºŒä½¿ç”¨
- âœ… MessagePack å·²é©—è­‰æœ‰æ•ˆï¼Œå¯å°å…¥ç”Ÿç”¢ç’°å¢ƒï¼ˆé æœŸå¯å†æ¸›å°‘ 44-50%ï¼‰
- ğŸ¯ è€ƒæ…®å°‡ playerID å„ªåŒ–ç‚º playerIndexï¼ˆå¯é€²ä¸€æ­¥æ¸›å°‘å‹•æ…‹ key çš„é–‹éŠ·ï¼‰
