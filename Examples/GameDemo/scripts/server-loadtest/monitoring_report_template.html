<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Server Load Test - System Monitoring Report</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.5.13/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            colors: {
              primary: "#3b82f6", // blue-500
              secondary: "#8b5cf6", // violet-500
              success: "#10b981", // emerald-500
              warning: "#f59e0b", // amber-500
              danger: "#ef4444", // red-500
              surface: "#1e293b", // slate-800
              background: "#0f172a", // slate-900
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a;
      }
      ::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }
    </style>
  </head>
  <body
    class="bg-background text-slate-100 min-h-screen antialiased selection:bg-primary selection:text-white"
  >
    <div id="app" class="pb-20">
      <!-- Header -->
      <header
        class="glass-panel sticky top-0 z-50 border-b border-white/5 shadow-2xl backdrop-blur-xl"
      >
        <div
          class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
        >
          <div class="flex items-center space-x-3">
            <div
              class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold shadow-lg shadow-primary/20"
            >
              üöÄ
            </div>
            <h1
              class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400"
            >
              Load Test Report
            </h1>
          </div>
          <div
            v-if="meta.timestampUTC"
            class="text-sm font-medium text-slate-400 bg-slate-800/50 px-3 py-1.5 rounded-full border border-white/5"
          >
            {{ new Date(meta.timestampUTC).toLocaleString() }}
          </div>
        </div>
      </header>

      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        <!-- Test Run Summary -->
        <section
          v-if="hasRunSummary"
          class="animate-fade-in"
          style="animation-delay: 0.1s"
        >
          <div class="flex items-center space-x-2 mb-4">
            <h2 class="text-lg font-semibold text-white">Test Run Summary</h2>
            <div
              class="h-px flex-1 bg-gradient-to-r from-white/10 to-transparent"
            ></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <summary-card
              title="Total Duration"
              icon="‚è±Ô∏è"
              :value="(run.totalSeconds ?? 'N/A') + 's'"
              :subvalue="`Ramp-up: ${run.rampUpSeconds||0}s | Steady: ${run.steadySeconds||0}s | Down: ${run.rampDownSeconds||0}s`"
              variant="primary"
            >
            </summary-card>
            <summary-card
              title="Total Data Sent"
              icon="üì°"
              :value="totalSentMb + ' MB'"
              :subvalue="(run.totalSentMessages || 0).toLocaleString() + ' msgs'"
              variant="info"
            >
            </summary-card>
            <summary-card
              title="Concurrent Rooms"
              icon="üèòÔ∏è"
              :value="run.roomsCreated ?? 'N/A'"
              :subvalue="'Target: ' + (run.roomsTarget ?? 'N/A')"
              variant="success"
            >
            </summary-card>
            <summary-card
              title="Concurrent Players"
              icon="üë§"
              :value="run.playersCreated ?? 'N/A'"
              subvalue="Total Active Users"
              variant="warning"
            >
            </summary-card>
          </div>
        </section>

        <!-- Phase Breakdown -->
        <section
          v-if="hasPhases"
          class="animate-fade-in"
          style="animation-delay: 0.15s"
        >
          <div class="glass-panel rounded-xl p-1 overflow-hidden">
            <div class="grid grid-cols-3 divide-x divide-white/5">
              <div
                v-for="p in stepsPhases"
                :key="p.key"
                class="p-4 text-center hover:bg-white/5 transition-colors"
              >
                <div
                  class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1"
                >
                  {{ p.label }}
                </div>
                <div class="text-xl font-bold text-white">
                  {{ phases[p.key] }}
                  <span class="text-sm font-normal text-slate-400"
                    >samples</span
                  >
                </div>
                <div class="text-xs text-slate-400 mt-1">
                  {{ phases[p.key] }} seconds
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Test Configuration & Environment Grid -->
        <div
          class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fade-in"
          style="animation-delay: 0.2s"
        >
          <!-- Config -->
          <section v-if="hasConfig">
            <div class="flex items-center space-x-2 mb-4">
              <h2 class="text-lg font-semibold text-white">Configuration</h2>
              <div
                class="h-px flex-1 bg-gradient-to-r from-white/10 to-transparent"
              ></div>
            </div>
            <div class="glass-panel rounded-xl p-5 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <config-item label="Rooms" :value="cfg.rooms"></config-item>
                <config-item
                  label="Players/Room"
                  :value="cfg.playersPerRoom"
                ></config-item>
                <config-item
                  label="Total Players"
                  :value="totalPlayersConfig"
                ></config-item>
                <config-item
                  label="Actions/Sec"
                  :value="cfg.actionsPerPlayerPerSecond + '/player'"
                ></config-item>
              </div>
              <div class="pt-4 border-t border-white/5">
                <config-item
                  label="Land Type"
                  :value="cfg.landType"
                ></config-item>
              </div>
            </div>
          </section>

          <!-- Environment -->
          <section v-if="hasEnv">
            <div class="flex items-center space-x-2 mb-4">
              <h2 class="text-lg font-semibold text-white">
                Server Environment
              </h2>
              <div
                class="h-px flex-1 bg-gradient-to-r from-white/10 to-transparent"
              ></div>
            </div>
            <div class="glass-panel rounded-xl p-5 space-y-4">
              <div class="flex items-center space-x-3">
                <div class="p-2 bg-slate-800 rounded-lg">üñ•Ô∏è</div>
                <div>
                  <div class="text-sm text-slate-400">Operating System</div>
                  <div class="text-white font-medium">
                    {{ env.osName || 'Unknown' }}
                    <span class="text-xs text-slate-500 ml-1"
                      >{{ env.kernelVersion }}</span
                    >
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 pt-2">
                <config-item
                  label="CPU Cores"
                  :value="env.cpuActiveLogicalCores"
                  :sub="env.arch"
                ></config-item>
                <config-item
                  label="Memory"
                  :value="(env.memoryTotalMB || 0) + ' MB'"
                ></config-item>
              </div>
            </div>
          </section>
        </div>

        <!-- Steady State Results -->
        <section
          v-if="steady"
          class="animate-fade-in"
          style="animation-delay: 0.25s"
        >
          <div class="flex items-center space-x-2 mb-4">
            <h2 class="text-lg font-semibold text-white">
              Steady State Performance
            </h2>
            <div
              class="px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wide bg-gradient-to-r from-green-500/20 to-teal-500/20 text-green-400 border border-green-500/30"
            >
              {{ steady.sample_count }} samples
            </div>
            <div
              class="h-px flex-1 bg-gradient-to-r from-white/10 to-transparent"
            ></div>
          </div>

          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"
          >
            <summary-card
              title="Avg Ingress"
              :value="steadyIngressKB + ' KB/s'"
              :subvalue="steady.avg_sent_mps.toFixed(1) + ' msgs/s'"
              small-text
            >
            </summary-card>
            <summary-card
              title="Avg Egress"
              :value="steadyEgressKB + ' KB/s'"
              :subvalue="steady.avg_recv_mps.toFixed(1) + ' msgs/s'"
              small-text
            >
            </summary-card>
            <summary-card
              title="Avg Actions"
              :value="steady.avg_actions.toFixed(1)"
              subvalue="Processed per second"
              small-text
            >
            </summary-card>
            <summary-card
              title="Update Rate"
              :value="steady.avg_update_time_ms.toFixed(2) + ' ms'"
              :subvalue="steadyRateLabel"
              :variant="getUpdateRateVariant(steady.avg_update_time_ms)"
            >
            </summary-card>
          </div>

          <!-- Detailed Performance Grid -->
          <div class="glass-panel rounded-xl overflow-hidden">
            <div class="px-6 py-4 border-b border-white/5 bg-white/[0.02]">
              <h3
                class="text-sm font-semibold text-slate-300 uppercase tracking-wider"
              >
                Tick & Sync Metrics
              </h3>
            </div>
            <div
              class="grid grid-cols-2 md:grid-cols-4 divide-y md:divide-y-0 divide-x divide-white/5 text-center"
            >
              <div class="p-4 group hover:bg-white/5 transition-colors">
                <div class="text-xs text-slate-500 mb-1">Ticks / Second</div>
                <div
                  class="text-lg font-bold text-white group-hover:text-primary transition-colors"
                >
                  {{ steady.avg_ticks_per_sec.toLocaleString() }}
                </div>
                <div class="text-xs text-slate-400">
                  ~{{ steady.avg_tick_time_ms.toFixed(2) }} ms
                </div>
              </div>
              <div class="p-4 group hover:bg-white/5 transition-colors">
                <div class="text-xs text-slate-500 mb-1">Syncs / Second</div>
                <div
                  class="text-lg font-bold text-white group-hover:text-secondary transition-colors"
                >
                  {{ steady.avg_syncs_per_sec.toLocaleString() }}
                </div>
                <div class="text-xs text-slate-400">
                  ~{{ steady.avg_sync_time_ms.toFixed(2) }} ms
                </div>
              </div>
              <div class="p-4 group hover:bg-white/5 transition-colors">
                <div class="text-xs text-slate-500 mb-1">Updates / Second</div>
                <div
                  class="text-lg font-bold text-white group-hover:text-success transition-colors"
                >
                  {{ steady.avg_updates_per_sec.toLocaleString() }}
                </div>
              </div>
              <div class="p-4 group hover:bg-white/5 transition-colors">
                <div class="text-xs text-slate-500 mb-1">Avg Message Size</div>
                <div
                  class="text-lg font-bold text-white group-hover:text-warning transition-colors"
                >
                  {{ (steady.avg_msg_size/1024).toFixed(2) }} KB
                </div>
                <div class="text-xs text-slate-400">
                  {{ Math.round(steady.avg_msg_size) }} Bytes
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- System Monitoring Cards -->
        <section class="animate-fade-in" style="animation-delay: 0.3s">
          <div class="flex items-center space-x-2 mb-4">
            <h2 class="text-lg font-semibold text-white">System Resources</h2>
            <div
              class="h-px flex-1 bg-gradient-to-r from-white/10 to-transparent"
            ></div>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <mini-stat
              label="Avg CPU User"
              :value="(vms.avg_cpu_us_pct ?? 0).toFixed(1) + '%'"
            ></mini-stat>
            <mini-stat
              label="Avg CPU System"
              :value="(vms.avg_cpu_sy_pct ?? 0).toFixed(1) + '%'"
            ></mini-stat>
            <mini-stat
              label="Avg CPU Idle"
              :value="(vms.avg_cpu_id_pct ?? 0).toFixed(1) + '%'"
            ></mini-stat>
            <mini-stat
              v-if="pds.sample_count"
              label="Process CPU"
              :value="(pds.avg_cpu_total_pct ?? 0).toFixed(1) + '%'"
            ></mini-stat>
            <mini-stat
              v-if="pds.sample_count"
              label="Peak CPU"
              :value="(pds.peak_cpu_total_pct ?? 0).toFixed(1) + '%'"
            ></mini-stat>
            <mini-stat
              label="VMStat Samples"
              :value="vms.sample_count ?? 0"
            ></mini-stat>
          </div>
        </section>

        <!-- Charts Section -->
        <section
          class="space-y-8 animate-fade-in"
          style="animation-delay: 0.35s"
        >
          <!-- OS Charts -->
          <div
            v-if="charts.vmstat?.times?.length"
            class="grid grid-cols-1 lg:grid-cols-2 gap-6"
          >
            <chart-container title="System CPU Usage" height="300px">
              <canvas ref="cpuChart"></canvas>
            </chart-container>
            <chart-container title="Free Memory (MB)" height="300px">
              <canvas ref="memoryChart"></canvas>
            </chart-container>
          </div>
          <div
            v-if="charts.pidstat?.times?.length"
            class="grid grid-cols-1 lg:grid-cols-1 gap-6"
          >
            <chart-container title="Process CPU Usage (%)" height="250px">
              <canvas ref="pidstatChart"></canvas>
            </chart-container>
          </div>

          <!-- Game Charts -->
          <div v-if="charts.game?.ticks?.length" class="space-y-6">
            <div class="flex items-center space-x-2">
              <h2 class="text-lg font-semibold text-white">
                Game Metrics
                <span class="text-sm font-normal text-slate-400 ml-2"
                  >(Tick-based)</span
                >
              </h2>
              <div
                class="h-px flex-1 bg-gradient-to-r from-white/10 to-transparent"
              ></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <chart-container title="Network Traffic (KB/s)" height="300px">
                <canvas ref="gameBytesChart"></canvas>
              </chart-container>
              <chart-container title="Message Rate (msgs/s)" height="300px">
                <canvas ref="gameMessagesChart"></canvas>
              </chart-container>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <chart-container
                title="Game Logic Load (Actions & Entities)"
                height="300px"
              >
                <canvas ref="gameActionsChart"></canvas>
              </chart-container>
              <chart-container
                title="Composite Metrics Overview"
                height="300px"
              >
                <canvas ref="gameAllMetricsChart"></canvas>
              </chart-container>
            </div>

            <!-- Performance Detail Charts -->
            <div
              v-if="charts.game?.ticks_per_second?.length"
              class="space-y-6 pt-6 border-t border-white/5"
            >
              <h3 class="text-md font-semibold text-slate-300">
                Detailed Latency Analysis
              </h3>

              <chart-container
                title="Update Loop Performance (Hz)"
                height="250px"
              >
                <canvas ref="updateRateChart"></canvas>
              </chart-container>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <chart-container
                  title="Average Update Time (ms)"
                  height="250px"
                >
                  <canvas ref="updateTimeChart"></canvas>
                </chart-container>
                <chart-container
                  title="Packet Size Distribution (KB)"
                  height="250px"
                >
                  <canvas ref="messageSizeChart"></canvas>
                </chart-container>
              </div>
            </div>
          </div>
        </section>

        <!-- JSON Dumps -->
        <section class="space-y-4 pt-8">
          <button
            @click="showJson = !showJson"
            class="flex items-center space-x-2 text-sm text-slate-400 hover:text-white transition-colors focus:outline-none"
          >
            <span>{{ showJson ? '‚ñº Hide' : '‚ñ∂ Show' }} Raw JSON Dump</span>
          </button>

          <div v-if="showJson" class="space-y-8 animate-fade-in">
            <div v-if="test_result">
              <h3 class="text-sm font-bold text-slate-500 mb-2">
                FULL RESULT JSON
              </h3>
              <json-viewer :data="test_result"></json-viewer>
            </div>
            <div v-if="monitoring && Object.keys(monitoring).length">
              <h3 class="text-sm font-bold text-slate-500 mb-2">
                MONITORING DATA JSON
              </h3>
              <json-viewer :data="monitoring"></json-viewer>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Data Injection Point -->
    <script type="application/json" id="report-payload">
      {{REPORT_DATA}}
    </script>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;

      // --- Components ---

      const SummaryCard = {
        props: {
          title: String,
          value: [String, Number],
          subvalue: String,
          icon: String,
          variant: { type: String, default: "primary" },
          smallText: Boolean,
        },
        setup(props) {
          const colors = {
            primary: "bg-primary/10 text-primary border-primary/20",
            secondary: "bg-secondary/10 text-secondary border-secondary/20",
            success: "bg-green-500/10 text-green-500 border-green-500/20",
            warning: "bg-amber-500/10 text-amber-500 border-amber-500/20",
            danger: "bg-red-500/10 text-red-500 border-red-500/20",
            info: "bg-sky-500/10 text-sky-500 border-sky-500/20",
          };
          const colorClass = computed(
            () => colors[props.variant] || colors.primary,
          );
          return { colorClass };
        },
        template: `
                <div class="glass-panel rounded-xl p-5 hover:bg-white/5 transition-all duration-300 hover:-translate-y-1 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-3 opacity-10 text-4xl group-hover:scale-110 group-hover:opacity-20 transition-all duration-500 grayscale group-hover:grayscale-0">
                        {{ icon }}
                    </div>
                    <h3 class="text-sm font-medium text-slate-400 uppercase tracking-wide mb-2">{{ title }}</h3>
                    <div :class="['font-bold text-slate-100 flex items-baseline gap-2', smallText ? 'text-xl' : 'text-3xl']">
                        {{ value }}
                    </div>
                    <div v-if="subvalue" class="mt-2 text-xs font-medium px-2 py-1 rounded inline-block" :class="colorClass">
                        {{ subvalue }}
                    </div>
                </div>
            `,
      };

      const ConfigItem = {
        props: ["label", "value", "sub"],
        template: `
                <div class="flex flex-col">
                    <span class="text-xs text-slate-500 uppercase">{{ label }}</span>
                    <span class="text-base text-slate-200 font-medium">{{ value ?? 'N/A' }} <span v-if="sub" class="text-xs text-slate-500 ml-1">{{ sub }}</span></span>
                </div>
            `,
      };

      const MiniStat = {
        props: ["label", "value"],
        template: `
                <div class="glass-panel rounded-lg p-3 text-center hover:bg-white/5 transition-colors">
                    <div class="text-xs text-slate-500 mb-1 truncate">{{ label }}</div>
                    <div class="text-lg font-bold text-white">{{ value }}</div>
                </div>
             `,
      };

      const ChartContainer = {
        props: ["title", "height"],
        template: `
                <div class="glass-panel rounded-xl p-5 flex flex-col h-full">
                    <h3 class="text-sm font-semibold text-slate-300 mb-4">{{ title }}</h3>
                    <div class="flex-1 w-full relative" :style="{ minHeight: height }">
                        <slot></slot>
                    </div>
                </div>
            `,
      };

      const JsonViewer = {
        props: ["data"],
        template: `
                <div class="bg-gray-900 rounded-xl overflow-hidden border border-white/10 shadow-inner">
                    <pre class="p-4 text-xs font-mono text-slate-300 overflow-x-auto max-h-96">{{ JSON.stringify(data, null, 2) }}</pre>
                </div>
            `,
      };

      // --- Main App ---

      createApp({
        components: {
          SummaryCard,
          ConfigItem,
          MiniStat,
          ChartContainer,
          JsonViewer,
        },
        setup() {
          const data = ref(getDefaultReportData());
          const showJson = ref(false);

          // Refs
          const cpuChart = ref(null);
          const memoryChart = ref(null);
          const pidstatChart = ref(null);
          const gameBytesChart = ref(null);
          const gameMessagesChart = ref(null);
          const gameActionsChart = ref(null);
          const gameAllMetricsChart = ref(null);
          const updateRateChart = ref(null);
          const updateTimeChart = ref(null);
          const messageSizeChart = ref(null);

          function getDefaultReportData() {
            // ... (same default structure as before)
            return {
              metadata: {
                timestampUTC: new Date().toISOString(),
                environment: {
                  osName: "Linux",
                  kernelVersion: "5.15.0-generic",
                  cpuActiveLogicalCores: 8,
                  arch: "x86_64",
                  memoryTotalMB: 16384,
                },
                loadTestConfig: {
                  rooms: 50,
                  playersPerRoom: 10,
                  actionsPerPlayerPerSecond: 5,
                  landType: "RECT_PARTITION",
                  steadySeconds: 60,
                  rampUpSeconds: 10,
                  rampDownSeconds: 10,
                },
              },
              run_summary: {
                totalSeconds: 80,
                rampUpSeconds: 10,
                steadySeconds: 60,
                rampDownSeconds: 10,
                totalSentBytes: 157286400, // ~150 MB
                totalSentMessages: 250000,
                roomsCreated: 50,
                roomsTarget: 50,
                playersCreated: 500,
              },
              phase_breakdown: {
                "ramp-up": 10,
                steady: 60,
                "ramp-down": 10,
              },
              config: {
                rooms: 50,
                playersPerRoom: 10,
                actionsPerPlayerPerSecond: 5,
                landType: "RECT_PARTITION",
                steadySeconds: 60,
                rampUpSeconds: 10,
                rampDownSeconds: 10,
              },
              env: {
                osName: "Linux",
                kernelVersion: "5.15.0-generic",
                cpuActiveLogicalCores: 8,
                arch: "x86_64",
                memoryTotalMB: 16384,
              },
              steady_stats: {
                sample_count: 60,
                avg_sent_bps: 2048000, // 2000 KB/s
                avg_recv_bps: 1024000, // 1000 KB/s
                avg_sent_mps: 4500.5,
                avg_recv_mps: 4500.2,
                avg_actions: 2500,
                avg_ticks_per_sec: 20,
                avg_tick_time_ms: 1.5,
                avg_syncs_per_sec: 20,
                avg_sync_time_ms: 2.2,
                avg_updates_per_sec: 20,
                avg_update_time_ms: 3.8,
                avg_msg_size: 450,
              },
              vmstat_summary: {
                sample_count: 80,
                avg_cpu_us_pct: 15.5,
                avg_cpu_sy_pct: 5.2,
                avg_cpu_id_pct: 79.3,
                peak_memory_free_kb: 8192000,
              },
              pidstat_summary: {
                sample_count: 80,
                avg_cpu_total_pct: 12.5,
                peak_cpu_total_pct: 25.0,
              },
              charts: {
                vmstat: {
                  times: Array.from({ length: 20 }, (_, i) => i),
                  cpu_us: Array.from(
                    { length: 20 },
                    () => 10 + Math.random() * 5,
                  ),
                  cpu_sy: Array.from(
                    { length: 20 },
                    () => 3 + Math.random() * 2,
                  ),
                  memory_free: Array.from(
                    { length: 20 },
                    () => 8000 - Math.random() * 100,
                  ),
                },
                pidstat: {
                  times: Array.from({ length: 20 }, (_, i) => i),
                  cpu: Array.from(
                    { length: 20 },
                    () => 10 + Math.random() * 10,
                  ),
                },
                game: {
                  ticks: Array.from({ length: 20 }, (_, i) => i * 50),
                  bytes_sent_kb: Array.from(
                    { length: 20 },
                    () => 1800 + Math.random() * 400,
                  ),
                  bytes_recv_kb: Array.from(
                    { length: 20 },
                    () => 900 + Math.random() * 200,
                  ),
                  messages_sent: Array.from(
                    { length: 20 },
                    () => 4000 + Math.random() * 500,
                  ),
                  messages_recv: Array.from(
                    { length: 20 },
                    () => 4000 + Math.random() * 500,
                  ),
                  actions: Array.from(
                    { length: 20 },
                    () => 2400 + Math.random() * 200,
                  ),
                  active_players: Array.from({ length: 20 }, () => 500),
                  active_rooms: Array.from({ length: 20 }, () => 50),
                  ticks_per_second: Array.from(
                    { length: 20 },
                    () => 19.8 + Math.random() * 0.4,
                  ),
                  syncs_per_second: Array.from(
                    { length: 20 },
                    () => 19.8 + Math.random() * 0.4,
                  ),
                  updates_per_second: Array.from(
                    { length: 20 },
                    () => 19.8 + Math.random() * 0.4,
                  ),
                  update_times_ms: Array.from(
                    { length: 20 },
                    () => 3 + Math.random() * 2,
                  ),
                  avg_message_size_kb: Array.from(
                    { length: 20 },
                    () => 0.4 + Math.random() * 0.1,
                  ),
                },
              },
              game_summary: {
                total_ticks: 1000,
                tick_interval_ms: 50,
                ticks_per_second: 20,
                peak_ingress_kb: 2200,
                peak_msgs: 4800,
                peak_actions: 2700,
              },
              test_result: { demo: "This is demo data" },
              monitoring: { demo: "This is demo monitoring data" },
            };
          }

          // Load Data logic
          const payloadEl = document.getElementById("report-payload");
          if (payloadEl) {
            try {
              const raw = payloadEl.textContent.trim();
              if (raw) data.value = JSON.parse(raw);
            } catch (e) {
              console.error("Failed to parse report data", e);
            }
          }

          // Computed
          const meta = computed(() => data.value.metadata || {});
          const run = computed(() => data.value.run_summary || {});
          const phases = computed(() => data.value.phase_breakdown || {});
          const cfg = computed(() => data.value.config || {});
          const env = computed(() => data.value.env || {});
          const steady = computed(() => data.value.steady_stats);
          const vms = computed(() => data.value.vmstat_summary || {});
          const pds = computed(() => data.value.pidstat_summary || {});
          const charts = computed(() => data.value.charts || {});
          const gs = computed(() => data.value.game_summary);
          const test_result = computed(() => data.value.test_result);
          const monitoring = computed(() => data.value.monitoring);

          const hasRunSummary = computed(
            () => Object.keys(run.value).length > 0,
          );
          const hasPhases = computed(
            () => Object.keys(phases.value).length > 0,
          );
          const hasConfig = computed(() => Object.keys(cfg.value).length > 0);
          const hasEnv = computed(() => Object.keys(env.value).length > 0);

          const totalSentMb = computed(() =>
            ((run.value.totalSentBytes || 0) / 1024 / 1024).toFixed(2),
          );
          const stepsPhases = [
            { key: "ramp-up", label: "Ramp-up" },
            { key: "steady", label: "Steady" },
            { key: "ramp-down", label: "Ramp-down" },
          ];
          const totalPlayersConfig = computed(
            () => (cfg.value.rooms || 0) * (cfg.value.playersPerRoom || 0),
          );

          const steadyIngressKB = computed(() =>
            steady.value ? (steady.value.avg_sent_bps / 1024).toFixed(1) : 0,
          );
          const steadyEgressKB = computed(() =>
            steady.value ? (steady.value.avg_recv_bps / 1024).toFixed(1) : 0,
          );
          const steadyRateLabel = computed(() => {
            if (!steady.value) return "";
            const ms = steady.value.avg_update_time_ms;
            return ms < 10
              ? "Excellent"
              : ms < 50
                ? "Acceptable"
                : "High Latency";
          });

          function getUpdateRateVariant(ms) {
            if (ms < 10) return "success";
            if (ms < 50) return "warning";
            return "danger";
          }

          // Chart Global Defaults
          Chart.defaults.color = "#94a3b8"; // slate-400
          Chart.defaults.borderColor = "#334155"; // slate-700
          Chart.defaults.font.family = "'Inter', sans-serif";
          Chart.defaults.plugins.tooltip.backgroundColor =
            "rgba(15, 23, 42, 0.9)"; // slate-900
          Chart.defaults.plugins.tooltip.titleColor = "#f8fafc"; // slate-50
          Chart.defaults.plugins.tooltip.bodyColor = "#e2e8f0"; // slate-200
          Chart.defaults.plugins.tooltip.borderColor = "rgba(255,255,255,0.1)";
          Chart.defaults.plugins.tooltip.borderWidth = 1;
          Chart.defaults.plugins.tooltip.padding = 10;
          Chart.defaults.plugins.tooltip.cornerRadius = 8;

          const chartColors = {
            blue: { border: "#3b82f6", bg: "rgba(59, 130, 246, 0.1)" },
            violet: { border: "#8b5cf6", bg: "rgba(139, 92, 246, 0.1)" },
            emerald: { border: "#10b981", bg: "rgba(16, 185, 129, 0.1)" },
            rose: { border: "#f43f5e", bg: "rgba(244, 63, 94, 0.1)" },
            amber: { border: "#f59e0b", bg: "rgba(245, 158, 11, 0.1)" },
            sky: { border: "#0ea5e9", bg: "rgba(14, 165, 233, 0.1)" },
            slate: { border: "#94a3b8", bg: "rgba(148, 163, 184, 0.1)" },
          };

          onMounted(async () => {
            await nextTick();
            renderCharts();
          });

          function renderCharts() {
            const commonOptions = {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", intersect: false },
              scales: {
                x: { grid: { display: false } },
                y: {
                  border: { display: false },
                  grid: { color: "rgba(255,255,255,0.05)" },
                },
              },
              plugins: {
                legend: { labels: { usePointStyle: true, boxWidth: 6 } },
              },
            };

            const createChart = (ctx, type, data, opts = {}) => {
              if (!ctx) return;
              new Chart(ctx.getContext("2d"), {
                type,
                data,
                options: { ...commonOptions, ...opts },
              });
            };

            // --- OS Charts ---
            const cv = charts.value.vmstat;
            if (cv && cv.times && cv.times.length) {
              createChart(
                cpuChart.value,
                "line",
                {
                  labels: cv.times,
                  datasets: [
                    {
                      label: "User %",
                      data: cv.cpu_us,
                      borderColor: chartColors.blue.border,
                      backgroundColor: chartColors.blue.bg,
                      tension: 0.3,
                      fill: true,
                    },
                    {
                      label: "System %",
                      data: cv.cpu_sy,
                      borderColor: chartColors.rose.border,
                      backgroundColor: chartColors.rose.bg,
                      tension: 0.3,
                      fill: true,
                    },
                  ],
                },
                { scales: { y: { max: 100 } } },
              );

              createChart(memoryChart.value, "line", {
                labels: cv.times,
                datasets: [
                  {
                    label: "Free Mem (MB)",
                    data: cv.memory_free,
                    borderColor: chartColors.emerald.border,
                    backgroundColor: chartColors.emerald.bg,
                    tension: 0.3,
                    fill: true,
                  },
                ],
              });
            }

            const cp = charts.value.pidstat;
            if (cp && cp.times && cp.times.length) {
              createChart(pidstatChart.value, "line", {
                labels: cp.times,
                datasets: [
                  {
                    label: "Process CPU %",
                    data: cp.cpu,
                    borderColor: chartColors.amber.border,
                    backgroundColor: chartColors.amber.bg,
                    tension: 0.3,
                    fill: true,
                  },
                ],
              });
            }

            // --- Game Charts ---
            const cg = charts.value.game;
            if (cg && cg.ticks && cg.ticks.length) {
              const ticks = cg.ticks;

              createChart(gameBytesChart.value, "line", {
                labels: ticks,
                datasets: [
                  {
                    label: "Ingress",
                    data: cg.bytes_sent_kb,
                    borderColor: chartColors.sky.border,
                    backgroundColor: chartColors.sky.bg,
                    tension: 0.1,
                    fill: true,
                  },
                  {
                    label: "Egress",
                    data: cg.bytes_recv_kb,
                    borderColor: chartColors.rose.border,
                    backgroundColor: chartColors.rose.bg,
                    tension: 0.1,
                    fill: true,
                  },
                ],
              });

              createChart(gameMessagesChart.value, "line", {
                labels: ticks,
                datasets: [
                  {
                    label: "Ingress",
                    data: cg.messages_sent,
                    borderColor: chartColors.blue.border,
                    backgroundColor: chartColors.blue.bg,
                    tension: 0.1,
                  },
                  {
                    label: "Egress",
                    data: cg.messages_recv,
                    borderColor: chartColors.violet.border,
                    backgroundColor: chartColors.violet.bg,
                    tension: 0.1,
                  },
                ],
              });

              createChart(
                gameActionsChart.value,
                "line",
                {
                  labels: ticks,
                  datasets: [
                    {
                      label: "Actions/s",
                      data: cg.actions,
                      borderColor: chartColors.amber.border,
                      backgroundColor: chartColors.amber.bg,
                      tension: 0.1,
                      yAxisID: "y",
                    },
                    {
                      label: "Active Players",
                      data: cg.active_players,
                      borderColor: chartColors.emerald.border,
                      borderDash: [5, 5],
                      tension: 0.1,
                      yAxisID: "y1",
                    },
                  ],
                },
                {
                  scales: {
                    y: { type: "linear", display: true, position: "left" },
                    y1: {
                      type: "linear",
                      display: true,
                      position: "right",
                      grid: { drawOnChartArea: false },
                    },
                  },
                },
              );

              // All Metrics Complex Chart
              const dsAll = [
                {
                  label: "Ingress KB/s",
                  data: cg.bytes_sent_kb,
                  borderColor: chartColors.sky.border,
                  hidden: false,
                  yAxisID: "y",
                },
                {
                  label: "Egress KB/s",
                  data: cg.bytes_recv_kb,
                  borderColor: chartColors.rose.border,
                  hidden: false,
                  yAxisID: "y",
                },
                {
                  label: "Actions/s",
                  data: cg.actions,
                  borderColor: chartColors.violet.border,
                  hidden: false,
                  yAxisID: "y",
                },
                {
                  label: "Players",
                  data: cg.active_players,
                  borderColor: chartColors.emerald.border,
                  borderDash: [5, 5],
                  hidden: false,
                  yAxisID: "y1",
                },
                {
                  label: "Rooms",
                  data: cg.active_rooms,
                  borderColor: chartColors.slate.border,
                  borderDash: [2, 2],
                  hidden: true,
                  yAxisID: "y1",
                },
              ];

              createChart(
                gameAllMetricsChart.value,
                "line",
                { labels: ticks, datasets: dsAll },
                {
                  scales: {
                    y: { type: "linear", display: true, position: "left" },
                    y1: {
                      type: "linear",
                      display: true,
                      position: "right",
                      grid: { drawOnChartArea: false },
                    },
                  },
                  plugins: {
                    legend: {
                      display: true,
                      onClick: function (e, item) {
                        var meta = this.chart.getDatasetMeta(item.datasetIndex);
                        meta.hidden =
                          meta.hidden === null
                            ? !this.chart.data.datasets[item.datasetIndex]
                                .hidden
                            : null;
                        this.chart.update();
                      },
                    },
                  },
                },
              );

              // Performance Detail Charts
              if (cg.ticks_per_second && cg.ticks_per_second.length) {
                createChart(updateRateChart.value, "line", {
                  labels: ticks,
                  datasets: [
                    {
                      label: "Ticks/s",
                      data: cg.ticks_per_second,
                      borderColor: chartColors.blue.border,
                      tension: 0.1,
                    },
                    {
                      label: "Updates/s",
                      data: cg.updates_per_second,
                      borderColor: chartColors.emerald.border,
                      tension: 0.1,
                    },
                  ],
                });

                createChart(updateTimeChart.value, "line", {
                  labels: ticks,
                  datasets: [
                    {
                      label: "Avg Update (ms)",
                      data: cg.update_times_ms,
                      borderColor: chartColors.amber.border,
                      backgroundColor: chartColors.amber.bg,
                      fill: true,
                      tension: 0.1,
                    },
                  ],
                });

                createChart(messageSizeChart.value, "line", {
                  labels: ticks,
                  datasets: [
                    {
                      label: "Avg Msg Size (KB)",
                      data: cg.avg_message_size_kb,
                      borderColor: chartColors.violet.border,
                      backgroundColor: chartColors.violet.bg,
                      fill: true,
                      tension: 0.1,
                    },
                  ],
                });
              }
            }
          }

          return {
            data,
            meta,
            run,
            phases,
            cfg,
            env,
            steady,
            vms,
            pds,
            charts,
            test_result,
            monitoring,
            hasRunSummary,
            hasPhases,
            hasConfig,
            hasEnv,
            totalSentMb,
            stepsPhases,
            totalPlayersConfig,
            steadyIngressKB,
            steadyEgressKB,
            steadyRateLabel,
            getUpdateRateVariant,
            showJson,
            cpuChart,
            memoryChart,
            pidstatChart,
            gameBytesChart,
            gameMessagesChart,
            gameActionsChart,
            gameAllMetricsChart,
            updateRateChart,
            updateTimeChart,
            messageSizeChart,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
