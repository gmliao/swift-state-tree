# 📊 峰值流量問題分析與修正

## 🔍 問題發現

**峰值數據異常高**:
- Peak Bytes/Sec: **406,505.2 KB/s** (~397 MB/s)
- Peak Messages/Sec: **7,701,239.0** msgs/s

這遠超過穩定期流量，不符合實際情境。

---

## 🎯 根本原因

### 問題：Ramp-up 時間太短

**當前配置（1000 rooms）**:
- Ramp-up 時間: **5 秒**
- 總玩家數: 5,000 (1000 rooms × 5 players)
- **每秒啟動: 1,000 玩家/秒**

**問題分析**:
1. **每個玩家 join 會觸發**:
   - Join Response (~1 KB)
   - Initial State Snapshot (~10-50 KB，取決於遊戲狀態大小)
   - 狀態更新消息

2. **峰值計算**:
   ```
   1,000 玩家/秒 × 50 KB/玩家 = 50,000 KB/s = 50 MB/s
   加上系統開銷和狀態更新 → 400+ MB/s 峰值
   ```

3. **不符合實際情境**:
   - 真實環境中，玩家不會同時上線
   - 通常玩家是陸續加入的（例如每秒 50-200 玩家）
   - 5 秒內啟動所有房間太激進

---

## ✅ 修正方案

### 1. 延長 Ramp-up 時間

**修正前**:
- Ramp-up: 5 秒
- 每秒啟動: 1,000 玩家/秒

**修正後**:
- Ramp-up: **30 秒**
- 每秒啟動: ~167 玩家/秒

**效果**:
- 峰值降低到 **1/6**（更符合實際情境）
- 更平滑的啟動曲線
- 減少系統壓力

### 2. 延長測試時間

**修正前**:
- 穩定期: 30 秒

**修正後**:
- 穩定期: **60 秒**

**效果**:
- 更穩定的數據收集
- 減少啟動階段的影響
- 更好的統計準確性

### 3. 調整 Ramp-down 時間

**修正前**:
- Ramp-down: 5 秒

**修正後**:
- Ramp-down: **10 秒**

**效果**:
- 更平滑的關閉過程
- 避免突然斷線導致的峰值

---

## 📊 預期改善

### 峰值流量對比

| 配置 | Ramp-up | 玩家/秒 | 預估峰值 | 評估 |
|------|---------|---------|----------|------|
| 修正前 | 5s | 1,000 | 400+ MB/s | 🔴 不現實 |
| 修正後 | 30s | ~167 | ~67 MB/s | 🟡 更合理 |

### 實際情境對比

| 場景 | 玩家/秒 | 說明 |
|------|---------|------|
| 測試（修正前） | 1,000 | 🔴 不現實 |
| 測試（修正後） | ~167 | 🟡 較合理 |
| 真實遊戲啟動 | 50-200 | ✅ 正常 |
| 真實遊戲高峰 | 100-500 | ✅ 正常 |

---

## 🔧 已修正的配置

### 腳本預設值更新

**`run-server-loadtest.sh`**:
```bash
DURATION_SECONDS=60      # 從 30 增加到 60
RAMP_UP_SECONDS=30       # 從 5 增加到 30
RAMP_DOWN_SECONDS=10     # 從 5 增加到 10
```

**`run-scalability-test.sh`**:
```bash
DURATION_SECONDS=60      # 保持 60
RAMP_UP_SECONDS=30       # 從 5 增加到 30
RAMP_DOWN_SECONDS=10     # 從 5 增加到 10
```

---

## 📝 建議的測試配置

### 小規模測試（< 100 rooms）
```bash
--ramp-up-seconds 10
--duration-seconds 30
```

### 中規模測試（100-500 rooms）
```bash
--ramp-up-seconds 20
--duration-seconds 60
```

### 大規模測試（500-1000+ rooms）
```bash
--ramp-up-seconds 30
--duration-seconds 60
```

### 超大規模測試（2000+ rooms）
```bash
--ramp-up-seconds 60
--duration-seconds 120
```

---

## 💡 為什麼這很重要？

### 1. **測試準確性**
- 峰值不代表真實負載
- 穩定期數據更能反映實際性能
- 延長測試時間獲得更好的統計數據

### 2. **系統壓力**
- 突然的峰值可能導致系統不穩定
- 平滑的 ramp-up 更接近真實場景
- 避免誤判系統容量

### 3. **實際情境**
- 真實遊戲中，玩家是陸續加入的
- 不會所有玩家同時上線
- 測試應該模擬真實行為

---

## 🎯 結論

✅ **問題已修正**:
- Ramp-up 時間: 5s → 30s
- 測試時長: 30s → 60s
- Ramp-down 時間: 5s → 10s

✅ **預期效果**:
- 峰值流量降低到 1/6
- 更符合實際情境
- 更穩定的測試數據
- 更好的系統壓力測試

---

**修正時間**: 2026-01-27  
**影響範圍**: 所有使用預設值的測試腳本
