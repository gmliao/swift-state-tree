// AUTO-GENERATED BY @swiftstatetree/sdk codegen.
// Do not edit this file directly.

import { ref, computed } from 'vue'
import type { Ref, ComputedRef } from 'vue'
import type { SessionMode } from '@swiftstatetree/sdk/core'
import { useHeroDefense } from './useHeroDefense.js'
import type { HeroDefenseComposableReturn } from './useHeroDefense.js'
import { useHeroDefenseReplay } from '../hero-defense-replay/useHeroDefenseReplay.js'
import type { HeroDefenseReplayComposableReturn } from '../hero-defense-replay/useHeroDefenseReplay.js'

type LiveConnectOptions = Parameters<HeroDefenseComposableReturn['connect']>[0]
type ReplayConnectOptions = Parameters<HeroDefenseReplayComposableReturn['connect']>[0]

const liveClient = useHeroDefense()
const replayClient = useHeroDefenseReplay()
const mode = ref<SessionMode>('live')
const isSwitching = ref(false)
const sessionError = ref<string | null>(null)
const liveConnectOptions = ref<LiveConnectOptions | null>(null)
const replayConnectOptions = ref<ReplayConnectOptions | null>(null)
const activeClient = computed(() => (mode.value === 'live' ? liveClient : replayClient))

const isConnecting = computed(() => isSwitching.value || activeClient.value.isConnecting.value)
const isConnected = computed(() => activeClient.value.isConnected.value)
const isJoined = computed(() => activeClient.value.isJoined.value)
const lastError = computed(() => sessionError.value ?? activeClient.value.lastError.value)
const tree = computed(() => activeClient.value.tree.value as any)
const state = computed(() => activeClient.value.state.value as any)
const currentPlayerID = computed(() => activeClient.value.currentPlayerID.value)

export interface SessionComposableReturn {
  mode: Ref<SessionMode>
  isConnecting: Ref<boolean>
  isConnected: Ref<boolean>
  isJoined: Ref<boolean>
  lastError: Ref<string | null>
  state: ComputedRef<any>
  currentPlayerID: ComputedRef<string | null>
  tree: ComputedRef<any>
  connect: (options: LiveConnectOptions) => Promise<void>
  connectLive: (options: LiveConnectOptions) => Promise<void>
  connectReplay: (options: ReplayConnectOptions) => Promise<void>
  switchToReplay: (options?: ReplayConnectOptions) => Promise<void>
  switchToLive: (options?: LiveConnectOptions) => Promise<void>
  disconnect: () => Promise<void>
  live: Readonly<any>
  replay: Readonly<any>
}

function asErrorMessage(error: unknown): string {
  return error instanceof Error ? error.message : String(error)
}

export function useHeroDefenseSession(): SessionComposableReturn {
  async function connectLive(options: LiveConnectOptions): Promise<void> {
    isSwitching.value = true
    sessionError.value = null
    liveConnectOptions.value = options
    try {
      await replayClient.disconnect()
      await liveClient.connect(options)
      mode.value = 'live'
    } catch (error) {
      sessionError.value = asErrorMessage(error)
      throw error
    } finally {
      isSwitching.value = false
    }
  }

  async function connectReplay(options: ReplayConnectOptions): Promise<void> {
    isSwitching.value = true
    sessionError.value = null
    replayConnectOptions.value = options
    try {
      await liveClient.disconnect()
      await replayClient.connect(options)
      mode.value = 'replay'
    } catch (error) {
      sessionError.value = asErrorMessage(error)
      throw error
    } finally {
      isSwitching.value = false
    }
  }

  async function switchToReplay(options?: ReplayConnectOptions): Promise<void> {
    const target = options ?? replayConnectOptions.value
    if (!target) {
      throw new Error('Replay connect options missing. Provide options or call connectReplay() first.')
    }
    await connectReplay(target)
  }

  async function switchToLive(options?: LiveConnectOptions): Promise<void> {
    const target = options ?? liveConnectOptions.value
    if (!target) {
      throw new Error('Live connect options missing. Provide options or call connectLive() first.')
    }
    await connectLive(target)
  }

  async function disconnect(): Promise<void> {
    await liveClient.disconnect()
    await replayClient.disconnect()
    mode.value = 'live'
    isSwitching.value = false
    sessionError.value = null
  }

  return {
    mode,
    isConnecting,
    isConnected,
    isJoined,
    lastError,
    state,
    currentPlayerID,
    tree,
    connect: connectLive,
    connectLive,
    connectReplay,
    switchToReplay,
    switchToLive,
    disconnect,
    live: liveClient,
    replay: replayClient
  }
}
