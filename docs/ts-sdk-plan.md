# TS/多平台 Schema Codegen 與 SDK 規劃

## 目標
- 從伺服端輸出的 `schema.json` 產生跨平台 SDK 所需的型別/常數，保持可重現：schema 變更 → 重跑 codegen → 各平台 SDK 自動對齊。
- 支援至少 TS 與 Unity（.NET）兩種 SDK，未來可再擴充。

## 目錄規劃
- `scripts/`: codegen 腳本
  - `gen-schema.ts`：讀 `Examples/HummingbirdDemo/schema.json`，輸出 TS 產物。
  - 未來如需 Unity/.NET，可新增 `gen-schema-csharp.ts` 或共用核心邏輯輸出 C#。
- `sdk/ts/`:
  - `generated/`: 自動產生的型別、常數、（可選）Zod validators。檔頭標註自動產生。
  - `src/`: 手寫 SDK，依賴 `generated/`，封裝連線、JWT header 握手、typed send/receive。
- `sdk/unity/`（或 `sdk/dotnet/`）:
  - `Generated/`: C# 自動產生的型別/常數。
  - `Runtime/`: 手寫 Unity/UPM SDK，封裝連線與 typed API。

## Codegen 輸出（以 TS 為例）
- `schema-types.ts`: defs 對應的型別（空物件事件如 `PingEvent` 變為 `Record<string, never>`）。
- `land-constants.ts`: Land/Action/ClientEvent/ServerEvent 字串常數與 union：
  - `LandId = 'demo-game'`
  - `ClientEventId = 'chat' | 'ping'`
  - `ServerEventId = 'chatmessage' | 'pong' | 'welcome'`
  - `ActionId = 'join'`
- `validators.ts`（可選）：Zod schema 用於送出/接收驗證。
- 生成檔標註 “AUTOGENERATED - DO NOT EDIT”。

## SDK API 草圖（TS）
- `createClient({ url, token?, landId })`：WebSocket 連線，支援握手 `Authorization: Bearer <token>`。
- `sendAction<'join'>(payload: JoinAction)`, `sendEvent<'chat'>(payload: ChatEvent)`.
- `onServerEvent<'pong'>((payload: PongEvent) => void)`, `onStateSnapshot`, `onStateDiff`.
- 內部使用 generated unions/maps 確保型別安全；若有 Zod，送出前/收到後可驗證。

## Workflow
1) 伺服端透過 `AnyLandDefinition.extractSchema()` 更新 `schema.json`。
2) 跑 `node scripts/gen-schema.ts` 生成 `sdk/ts/generated`（未來可加 C# 生成）。
3) SDK 僅引用 `generated`，不手改型別；前端/Unity 直接吃 SDK。
4) CI 可在發佈前自動跑 codegen，再 build/publish npm 包或 UPM。

## 版本與相容性
- 以 schema 為核心做版本同步：schema 版本升級 → TS/Unity SDK 主版號同步提升。
- 在 generated 檔輸出 `SCHEMA_VERSION` 供連線回報，伺服端可檢查相容性。
- 保留生成檔可提交（或忽略），視發佈策略決定；若忽略，需在 CI 生成。
