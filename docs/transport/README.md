[English](README.md) | [中文版](README.zh-TW.md)

# Transport

Transport layer connects network connections with LandKeeper, with the core goal of "not exposing network details to Land DSL".

## Design Focus

- Land layer only cares about `LandContext` and handlers, doesn't know WebSocket/HTTP details
- Transport layer is responsible for connection management, message serialization, and routing
- Synchronization uses snapshot + diff to avoid blocking state mutation

## Data Flow

```
Client ↔ WebSocketTransport ↔ TransportAdapter ↔ LandKeeper
```

## Three-Layer Identification

- `playerID`: Account/player identity (business layer)
- `clientID`: Device or client instance (provided by application)
- `sessionID`: Connection layer identification (generated by server)

These three layers of identification enter `LandContext`, giving handlers a consistent interface,
and supporting multi-device, multi-connection behavior control.

## Core Components

- Transport protocol: Abstract connection behavior (start/stop/send)
- WebSocketTransport: Default WebSocket implementation
- TransportAdapter: Parse messages and call LandKeeper
- LandManager / Registry: Manage multiple rooms
- LandRouter / LandRealm: Cross-room routing and control

For integrating SwiftStateTree with another HTTP/WebSocket framework (e.g. Vapor, Kitura), see [Server Integration Guide](server-integration.md).

## Join and Session Flow

- Client must explicitly send join request
- Join creates `PlayerSession` and executes `CanJoin` / `OnJoin` in order
- Initial join returns snapshot, subsequent updates use `StateUpdate` (firstSync/diff)

PlayerSession field priority:

1. join request content
2. JWT payload
3. guest session

## Synchronization Model

- snapshot: Complete state (including per-player filtering)
- diff: Only send changes (path-based patches)
- firstSync: Sent once after player's cache is first established

### Broadcast vs Per-Player Updates

- **Broadcast**: Encoded once per sync tick and sent to all sessions (opcode **107** when using MessagePack).
- **Per-player**: Sent as standard StateUpdate opcodes (0/1/2) per player, separate from broadcast.
- **firstSync**: Remains a single combined update (full state for that player).
- **Events**: Broadcast events can be merged into opcode 107; targeted events are sent separately.

## Error Handling

- join/action/event errors return `ErrorPayload`
- Join checks landID and session state to avoid duplicate joins or incorrect routing

## Multi-Room Support

- `LandManager` manages Land lifecycle and queries
- `LandRouter` routes connections to corresponding land
- In multi-room mode, join routes based on landType + instanceId

## WebSocket Path for LB / K8s

Server accepts both:
- `/game/{landType}` (e.g. `/game/hero-defense`)
- `/game/{landType}/{instanceId}` (e.g. `/game/hero-defense/room-abc`) — for path-based routing

Client must send Join with `landID: "landType:instanceId"`. See [Deploy & LB](../deploy/README.md).

## State Update Encoding

State updates are encoded serially per sync cycle. Per-player updates within a room are encoded one after another; for multi-room scenarios, each `TransportAdapter` manages one room independently.

## Environment Variables

Transport-related behavior can be tuned via environment variables. All variables are read at `TransportAdapter` init time. The complete list and parsing rules are documented in `TransportEnvConfig` (SwiftStateTreeTransport module).

| Variable | Type | Default | Description |
|----------|------|---------|-------------|
| `ENABLE_DIRTY_TRACKING` | Bool | init param | Enable dirty-field tracking for smaller diffs; disable for high-update-ratio scenarios |
| `USE_SNAPSHOT_FOR_SYNC` | Bool | true | Use one-pass snapshot extraction; set to `false` for legacy separate broadcast + per-player path |
| `ENABLE_CHANGE_OBJECT_METRICS` | Bool | false | Log changed-vs-unchanged object ratio per sync |
| `CHANGE_OBJECT_METRICS_LOG_EVERY` | Int | 10 | Sync cycles between change-object metric logs |
| `CHANGE_OBJECT_METRICS_EMA_ALPHA` | Double | 0.2 | EMA alpha for change rate (0.01–1.0) |
| `AUTO_DIRTY_TRACKING` | Bool | true | Auto-switch dirty tracking based on change rate hysteresis |
| `AUTO_DIRTY_OFF_THRESHOLD` | Double | 0.55 | EMA threshold to switch dirty tracking OFF |
| `AUTO_DIRTY_ON_THRESHOLD` | Double | 0.30 | EMA threshold to switch dirty tracking ON |
| `AUTO_DIRTY_REQUIRED_SAMPLES` | Int | 30 | Consecutive samples before mode switch |
| `TRANSPORT_PROFILE_JSONL_PATH` | String | (disabled) | When set, enables transport profiling and writes JSONL to this path |
| `TRANSPORT_PROFILE_INTERVAL_MS` | Int | 1000 | Profiling write interval in ms (min 100) |
| `TRANSPORT_PROFILE_SAMPLE_RATE` | Double | 0.01 | Latency sample rate (0.001–1.0) |
| `TRANSPORT_PROFILE_MAX_SAMPLES_PER_INTERVAL` | Int | 500 | Max latency samples per interval (10–10000) |

Boolean parsing: truthy = `1`, `true`, `yes`, `y`, `on`; falsy = `0`, `false`, `no`, `n`, `off`.
