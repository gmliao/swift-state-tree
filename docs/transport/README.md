[English](README.md) | [中文版](README.zh-TW.md)

# Transport

Transport layer connects network connections with LandKeeper, with the core goal of "not exposing network details to Land DSL".

## Design Focus

- Land layer only cares about `LandContext` and handlers, doesn't know WebSocket/HTTP details
- Transport layer is responsible for connection management, message serialization, and routing
- Synchronization uses snapshot + diff to avoid blocking state mutation

## Data Flow

```
Client ↔ WebSocketTransport ↔ TransportAdapter ↔ LandKeeper
```

## Three-Layer Identification

- `playerID`: Account/player identity (business layer)
- `clientID`: Device or client instance (provided by application)
- `sessionID`: Connection layer identification (generated by server)

These three layers of identification enter `LandContext`, giving handlers a consistent interface,
and supporting multi-device, multi-connection behavior control.

## Core Components

- Transport protocol: Abstract connection behavior (start/stop/send)
- WebSocketTransport: Default WebSocket implementation
- TransportAdapter: Parse messages and call LandKeeper
- LandManager / Registry: Manage multiple rooms
- LandRouter / LandRealm: Cross-room routing and control

For integrating SwiftStateTree with another HTTP/WebSocket framework (e.g. Vapor, Kitura), see [Server Integration Guide](server-integration.md).

## Join and Session Flow

- Client must explicitly send join request
- Join creates `PlayerSession` and executes `CanJoin` / `OnJoin` in order
- Initial join returns snapshot, subsequent updates use `StateUpdate` (firstSync/diff)

PlayerSession field priority:

1. join request content
2. JWT payload
3. guest session

## Synchronization Model

- snapshot: Complete state (including per-player filtering)
- diff: Only send changes (path-based patches)
- firstSync: Sent once after player's cache is first established

### Broadcast vs Per-Player Updates

- **Broadcast**: Encoded once per sync tick and sent to all sessions (opcode **107** when using MessagePack).
- **Per-player**: Sent as standard StateUpdate opcodes (0/1/2) per player, separate from broadcast.
- **firstSync**: Remains a single combined update (full state for that player).
- **Events**: Broadcast events can be merged into opcode 107; targeted events are sent separately.

## Error Handling

- join/action/event errors return `ErrorPayload`
- Join checks landID and session state to avoid duplicate joins or incorrect routing

## Multi-Room Support

- `LandManager` manages Land lifecycle and queries
- `LandRouter` routes connections to corresponding land
- In multi-room mode, join routes based on landType + instanceId

## State Update Encoding

State updates are encoded serially per sync cycle. Per-player updates within a room are encoded one after another; for multi-room scenarios, each `TransportAdapter` manages one room independently.
